{
  "_id": {
    "$oid": "597f28d97c18e31a6c8fa738"
  },
  "name": "payture_wallet_users",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      }
    },
    "fields": {
      "login": {
        "type": "string",
        "name": "login"
      },
      "password": {
        "type": "string",
        "name": "password"
      },
      "phone": {
        "type": "string",
        "name": "phone"
      },
      "date": {
        "type": "date",
        "name": "date"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "59b8ed928e8c9a021d48d5c3"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "\n/**\n  Подгрузка продуктов по категории, включая ТОП.\n*/\n\nif (!data.category_id) throw new Error(400, 'Bad request!');\n  const contragentRole = '58860d1bc6887053b5978bb3';\n  const adminRole = '58808abccf1f550f22a8c02a';\n  const usersTable = yield Table.fetch('users', req.application.id);\n  const topCategoryId = '58e5f191d351f81cc3fa6a0a';\n  const productsTable = yield Table.fetch('products',req.application.id);\n  const activeStatus = '598d9bac47217f28ba69e0f5';\n  const limitsTable = yield Table.fetch('limits', req.application.id);\n  if (data.category_id === topCategoryId) {\n\n  const options = {\n    \"sort\": {\n      \"buy_date\": -1\n    }\n  };\n\nlet top_products = yield productsTable.findAll({categories: topCategoryId, status: activeStatus});\n\n// Получение категории топ для админа\n    if (req.user.role.id == adminRole) {\n      return done(top_products.data);\n    }\n  \n// Получение категории топ для контрагента\n    if (req.user.role.id == contragentRole) {\n      let caResult = [];\n      top_products.data.map(prod =\u003e {\n        if (~prod.user_id.indexOf(req.user.id)) caResult.push(prod);\n      });\n      return done(caResult);\n    }\n\n// Получение категории топ для мобилы\n    let result = [];\n    const certificatesTable = yield Table.fetch('certificates', req.application.id);\n    let buyedCertificates = yield certificatesTable.findAll({buyer_id: req.user.id}, options);\n    let products = [];\n       buyedCertificates.data.map(certificate =\u003e {\n         if (certificate.product.status.id == activeStatus) {\n            let ind = products.findIndex(prod =\u003e {\n              return certificate.product.id.toString() == prod.id.toString();\n          });\n          if (ind == -1) products.push(certificate.product);\n         }\n      });\n\n// products - уникальные продукты от купленных джипонов - в порядке купленных джипонов - самый свежий первый\n      /**\n          Сертификаты приходят по убыванию даты покупки. Первый цикл отбора выше \n          составляет продукты в обратном порядке. Теперь нужно их ревертнуть\n      */\n    //  products.reverse();\n\n      if (products.length \u003e= 20) {\n        result = products.slice(0, 20);\n      }\n\n      if (products.length == 0) {\n        result= [...top_products.data];\n      }\n\n      if (products.length \u003e 0 \u0026\u0026 products.length \u003c 20) {\n        products.reverse(); // делаем реверс, чтобы правильно расставить элементы в массив top_products\n        products.map(product =\u003e {\n          let ind = top_products.data.findIndex(element =\u003e {\n            return element.id.toString() == product.id.toString();\n          });\n\n          if (ind == -1 ) {\n            if (top_products.data.length == 20) top_products.data.pop();\n            top_products.data.unshift(product);\n          } else {\n            top_products.data.splice(ind, 1);\n            top_products.data.unshift(product);\n          }\n        });\n        result = top_products.data;\n      }\n    yield result.map(function* (product) {\n      let limit = yield limitsTable.find({product_id: product.id}).catch(e =\u003e (console.log(e), {data: null}));\n      if (!limit.data) throw new Error(404, 'Limit not found')\n      Object.assign(product, {product_limit: limit.data.limit});\n    });\n      \n    return done(result);\n\n\n  } else {\n\n    let options = {};\n      if (data.limit) options.limit = data.limit;\n      if (data.page) options.skip = data.page * data.limit || 0;\n      if (data.sort) options.sort = data.sort;\n\n    if (req.user.role.id == adminRole) {\n      let products = yield productsTable.findAll({categories: data.category_id, status: activeStatus}, options);\n      return done(products.data);\n    }\n\n    if (req.user.role.id == contragentRole) {\n      let products = yield productsTable.findAll({categories: data.category_id, status: activeStatus, user_id: req.user.id}, options);\n      return done(products.data);\n    } \n\n// if req.user.role.id == mobile\n    let params = {\n      categories: data.category_id,\n      status: activeStatus,\n      $and:[{contragent:{$nin: [null]}}, {contragent:{ $ne: [] }},{contragent:{$exists: true}}, {user_id:{$nin: [null]}},\n      {user_id:{ $ne: [] }},{user_id:{$exists: true}}]\n    };\n\n    const checkAdultScript = yield Script.fetch('check_is_adult', req.application.id);\n    checkAdultScript.req = req;\n    checkAdultScript.data = {};\n    let check_adult = yield checkAdultScript.run();\n    if (!check_adult) {\n          Object.assign(params, {is_adult: false});\n      }\n\n    let products = yield productsTable.findAll(params);\n\n    yield products.data.map(function* (product) {\n\n      let limit = yield limitsTable.find({product_id: product.id}).catch(e =\u003e (console.log(e), {data: null}));\n      if (!limit.data) throw new Error(404, 'Limit not found')\n      Object.assign(product, {product_limit: limit.data.limit});\n    });\n\n\n    return done(products.data);\n  }\n"
  },
  "name": "products_by_category",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59bb6e3c8e8c9a021d48dda5"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт сбора информации по денежным потокам\n *\n * @param {date} start_date date - дата начала периода отчета(не обязательный)\n * @param {date} end_date - дата конца периода отчета(не обязательный)\n * @param {string} contragent_id - id контрагента для выгрузки(только для администратора и не обязательный)\n * @param {string array} product_id - массив id продуктов для выгрузки(не обязательный)\n *\n * Если не были указаны параметры, статистика будет собрана\n * за весь период работы приложения по всем товарам\n * для контрагента или контрагентов(в случае администратора)\n */\n\nlet start_date = data.start_date ? new Date(data.start_date).getTime() : new Date(0);\nlet end_date = data.end_date ? new Date(data.end_date).getTime() : new Date();\n\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst adminRole = '58808abccf1f550f22a8c02a';\n\nlet allow = [contragentRole, adminRole].some((role) =\u003e role == req.user.role.id);\n\nif (!allow) { throw new Error(400, 'Bad request'); }\n\nlet contractorFilter;\nif (req.user.role.id == contragentRole) { contractorFilter = {user_id: req.user.id}; }\nif (req.user.role.id == adminRole) { contractorFilter = {id: data.contragent_id}; }\n\nconst contragentsTable = yield Table.fetch('contragents', req.application.id);\nlet contragent = yield contragentsTable.find(contractorFilter)\n  .catch(error =\u003e (console.error(error), { data: null }));\n\n// console.log('Contragents:', contragent);\nif (!contragent.data) { throw new Error(400, 'Contragent not found'); }\nlet userId = contragent.data.user_id;\nlet contragentId = contragent.data.id;\n\n// Инициализация таблиц для подсчета статистики\nconst productsTable = yield Table.fetch('products', req.application.id);\nconst ordersTable = yield Table.fetch('payture_orders', req.application.id);\nconst certificateCashingTable = yield Table.fetch('certificate_cashing', req.application.id);\n\n// Поиск продуктов по фильтру, опционально список из запроса\nlet productsFilter;\nproductsFilter = {contragent: contragentId};\n\nif (data.product_id) {\n  productsFilter.id = {$in: data.product_id};\n}\n\n// console.log('Products filter', productsFilter);\nlet products = yield productsTable.findAll(productsFilter);\n\n/**\n * Граница успешного рефакторинга\n */\nfunction boughtFilter(productId) {\n  let boughtFilter = {$and: [{product_id: productId.toString()}, {status: 0}]};\n  if (data.start_date) { boughtFilter['$and'].push({date: {$gte: data.start_date}}); }\n  if (data.end_date) { boughtFilter['$and'].push({date: {$lte: data.end_date}}); }\n\n//  console.log('Bought filter:\\n', boughtFilter);\n  return boughtFilter;\n}\n\nfunction cashingFilter(productId) {\n  let cashingFilter = {$and: [{product_id: productId.toString()}, {contragent_id: userId}]};\n  if (data.start_date) { cashingFilter['$and'].push({createdAt: {$gte: data.start_date}}); }\n  if (data.end_date) { cashingFilter['$and'].push({createdAt: {$lte: data.end_date}}); }\n\n//  console.log('Cashing filter:\\n', cashingFilter);\n  return cashingFilter;\n}\n\nlet result = {};\nyield products.data.map(function* (product) {\n  let object = {};\n\n  let availableGpons = 0;\n  let availableGponsPrice;\n\n  // Сбор данных о за период куплено в рублях\n\n  let options = {sort: {date: -1}};\n  let boughtGpons = yield ordersTable.findAll(boughtFilter(product.id), options);\n  \n  if(product.id == '5a4226e5b4f5194db84836f3')   console.log(\"BIUGTH\", boughtGpons.data)\n\n\n  let soldAmount = 0;\n  boughtGpons.data.map(boughtGpon =\u003e {\n    soldAmount += boughtGpon.amount \u0026\u0026 boughtGpon.amount / 100 || 0;\n  });\n\n  Object.assign(object, {\n    sold_value: boughtGpons.data.length,\n    sold_amount: soldAmount\n  });\n\n  // Сбор данных о стоимости доступных джипонов\n  let limit = boughtGpons.data.length \u0026\u0026 boughtGpons.data[0] || {};\n  let limitValue =  limit.current_limit || 0;\n  let limitAmount = limitValue * (limit.amount \u0026\u0026 limit.amount / 100 || 0);\n  \n  Object.assign(object, {\n    limit_value: limitValue,\n    limit_amount: limitAmount\n  });\n\n  // За период погашено в рублях\n  let cashedGpons = yield certificateCashingTable.findAll(cashingFilter(product.id));\n // console.log('Cashed gpons:\\n', cashedGpons);\n  let cashedAmount = 0;\n  cashedGpons.data.map(cashedGpon =\u003e {\n  //  console.log('Cashed gpon:\\n', cashedGpon);\n    cashedAmount += cashedGpon.cashing_price || 0;\n  });\n\n  Object.assign(object, {\n    cashed_value: cashedGpons.data.length,\n    cashed_amount: cashedAmount\n  });\n\n  // Принадлежит нескольким контрагентам\n  // console.log('Contragent:\\n', product.contragent);\n  // console.log('User id:\\n', product.user_id);\n  let multiOwner = false;\n  if (product.user_id.length \u003e 1) { multiOwner = true; }\n  Object.assign(object, {multi_owner: multiOwner});\n\n  //Наполняем результирующий объект информацией о продукте\n  Object.assign(result, {[product.id]: object});\n});\n\n/**\n * Модуль просчета Итого по контрагенту\n */\n\nlet summaryLimitValue = 0;\nlet summaryLimitAmount = 0;\nlet summarySoldValue = 0;\nlet summarySoldAmount = 0;\nlet summaryCashedValue = 0;\nlet summaryCashedAmount= 0;\n\nObject.keys(result).map(key =\u003e {\n  summaryLimitValue += result[key].limit_value;\n  summaryLimitAmount += result[key].limit_amount;\n  summarySoldValue += result[key].sold_value;\n  summarySoldAmount += result[key].sold_amount;\n  summaryCashedValue += result[key].cashed_value;\n  summaryCashedAmount += result[key].cashed_amount;\n});\n\nlet summary = Object.assign({}, {\n  limit_value: summaryLimitValue,\n  limit_amount: summaryLimitAmount,\n  sold_value: summarySoldValue,\n  sold_amount: summarySoldAmount,\n  cashed_value: summaryCashedValue,\n  cashed_amount: summaryCashedAmount\n});\n\nreturn done({\n  contractor_name: contragent.data.name,\n  data: result,\n  summary: summary\n});\n"
  },
  "name": "contragent_fin_stream",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59b15140bc280b12d32b98b0"
  },
  "name": "certificate_owning_history",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "owner_id": {
        "type": "string",
        "name": "owner_id"
      },
      "certificate": {
        "ref": "587641c295ed3c0c59b14603",
        "populate": false,
        "type": "referer",
        "name": "certificate"
      },
      "status_updated_at": {
        "type": "date",
        "name": "status_updated_at"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "59b2af3abc280b12d32b9b0e"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n  Скрипт используется в мобилке, из него же подгружаются маганизы на карту\n*/\n\nif (data.product_id) {\n  const activeStatus = '598d9bac47217f28ba69e0f5';\n  const caArray = [];\n  const productTable = yield Table.fetch('products', req.application.id);\n  const storesTable = yield Table.fetch('stores', req.application.id);\n  const product = yield productTable.find({id: data.product_id}).catch(e =\u003e (console.error(e), { data: null }));\n  yield product.data.contragent.map(function* (ca) {\n    let stores = yield storesTable.findAll({contragent: ca.id, status: activeStatus});\n    Object.assign(ca, {stores: stores.data});\n    caArray.push(ca);\n  });\n  return done(caArray);\n} throw new Error(400, 'Not enough params!');\n"
  },
  "name": "contragents_by_product",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59b7c31b8e8c9a021d48d521"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт сохранения сертификата в истории полученных\n *\n * @param {string} certificate_id - id сертификата\n */\n\nif (!data.certificate_id) {\n  return done({\n    statusCode: 400,\n    message: 'Certificate id required'\n  });\n}\n\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nconst certificateTable = yield Table.fetch('certificates', req.application.id);\nlet certificate = yield certificateTable.find({id: data.certificate_id}).catch(error =\u003e (console.error(error), { data: null }));\n\nif (certificate.data.status.id != activeStatus) {\n  return done({\n    statusCode: 400,\n    message: 'Gpon status is not active'\n  });\n\n} \n\nconst certificateGivingTable = yield Table.fetch('certificate_giving_history', req.application.id);\nconst sentCertificates = yield certificateGivingTable.find({\n  giver_id: req.user.id,\n  certificate: data.certificate_id\n}).catch(error =\u003e (console.error(error), { data: null }));\n\nif (!sentCertificates.data) {\n  const certificateOwningTable = yield Table.fetch('certificate_owning_history', req.application.id);\n  let ownedCertificate = yield certificateOwningTable.find({certificate: data.certificate_id}).catch(error =\u003e (console.error(error), { data: null }));\n\nlet check_adult = true;\n\nif (certificate.data.product.is_adult == true) {\n  const checkAdultScript = yield Script.fetch('check_is_adult', req.application.id);\n  checkAdultScript.req = req;\n  checkAdultScript.data = {};\n  check_adult = yield checkAdultScript.run();\n}\n\nif (check_adult) {\n    if (!ownedCertificate.data) {\n    ownedCertificate = yield certificateOwningTable.create({\n      owner_id: req.user.id,\n      certificate: data.certificate_id,\n      status_updated_at: Date.now()\n    });\n  } else {\n    yield ownedCertificate.data.update({owner_id: req.user.id, status_updated_at: Date.now()});\n  }\n} else {\n  return done({\n    statusCode: 400,\n    message: 'Adult gpon'\n  });\n}\n\n  return done(ownedCertificate);\n}\n\nreturn done({\n    statusCode: 400,\n    message: 'Certificate is already been this user'\n});"
  },
  "name": "set_my_certificates",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "592e5ddc5187d01f677a1e4e"
  },
  "name": "payture_orders",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "adapter": "MongoDB",
    "fields": {
      "transaction_id": {
        "name": "transaction_id",
        "type": "string"
      },
      "current_limit": {
        "name": "current_limit",
        "type": "number"
      },
      "state": {
        "name": "state",
        "type": "string"
      },
      "type": {
        "name": "type",
        "type": "string"
      },
      "order_id": {
        "name": "order_id",
        "type": "string"
      },
      "product_id": {
        "name": "product_id",
        "type": "string"
      },
      "buyer_id": {
        "name": "buyer_id",
        "type": "string"
      },
      "user_id": {
        "name": "user_id",
        "type": "string",
        "array": false
      },
      "date": {
        "name": "date",
        "type": "date"
      },
      "status": {
        "name": "status",
        "type": "number",
        "required": true
      },
      "amount": {
        "name": "amount",
        "type": "number"
      }
    },
    "rules": {
      "all": {
        "select": [
          "state",
          "status",
          "order_id"
        ],
        "access": [
          "list",
          "view"
        ]
      },
      "public": {
        "access": []
      }
    },
    "triggers": "",
    "params": {
      "timestamps": true
    }
  }
}
{
  "_id": {
    "$oid": "58b91e756521367de466f328"
  },
  "name": "images",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "create",
          "view"
        ]
      }
    },
    "fields": {
      "image": {
        "type": "file",
        "name": "image"
      },
      "type": {
        "type": "string",
        "name": "type"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5979ea6129e7625456d790b5"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт проверки на существование username в системе\n *\n * @param {string} username - логин нового юзера в системе\n * @param {string} name - имя нового юзера в системе\n * @param {string} role - роль нового юзера в системе('contragents' или 'subcontragents')\n */\n\nif ((!data.username \u0026\u0026 !data.name) || !data.role) {\n  throw new Error(400, 'Enter correct data!');\n}\n\nlet role;\nswitch (data.role) {\n  case 'contragents':\n    role = '58860d1bc6887053b5978bb3';\n    break;\n\n  case 'subcontragents':\n    role = '5988108288955d4a0dc7d644';\n    break;\n}\n\nif (!role) { throw new Error(404, 'Incorrect agent role'); }\n const contragentsTable = yield Table.fetch('contragents', req.application.id);\nlet result = { data: {}};\n\nif (data.username) {\n  data.username = data.username.toLowerCase();\n\n  let userSys = yield User.find({username: data.username},\n                                {},\n                                req.application.id);\n\n\n  const usersTable = yield Table.fetch('users', req.application.id);\n\n  let user = yield usersTable.find({email: data.username}).catch(e =\u003e (console.error(e), { data: null }));\n  let contragent = yield contragentsTable.find({$or: [ { email: data.username }, { delivery_email: data.username }]}).catch(e =\u003e (console.error(e), { data: null }));\n\n\n  if (userSys || user.data || contragent.data) { throw new Error(400, 'Username already exists!'); }\n\n\n  Object.assign(result.data, {checkUsername: 'OK!'});\n\n}\n\nif (data.name) {\n  let agentsTable = yield Table.fetch(data.role, req.application.id);\n  let agents = yield contragentsTable.findAll({name:{$regex : data.name, $options : 'i'}});\n\n  agents.data.map(agent =\u003e {\n    if (agent.name.toLowerCase() === data.name.toLowerCase()) {\n      throw new Error(400, 'Name already exists!');\n    }\n  });\n\n  Object.assign(result.data, {checkName: 'OK!'});\n}\n\nreturn done(result);"
  },
  "name": "check_unique_params",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "597ae82d29e7625456d794da"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт создания контрагента\n *\n * @param {string} username - логин пользователя в системе\n\n * @param {string} name - название контрагента\n * @param {string} phone - телефон контрагента\n * @param {string} fact_city - фактический город контрагента\n * @param {string} subcontragentUsername - логин представителя контрагента\n * @param {string} subcontragentPassword - пароль представителя контрагента \n * @param - остальные как в БД по желанию\n */\n\nif (!data.username || !data.phone || !data.fact_city || !data.subcontragentUsername || !data.subcontragentPassword) {\n  throw new Error(400, 'Enter correct data!');\n}\n\nif (data.username.toLowerCase() == data.subcontragentUsername.toLowerCase()) throw new Error(400, 'Same contragent and subcontragent login!');\n\ndata.username = data.username.toLowerCase();\ndata.subcontragentUsername = data.subcontragentUsername.toLowerCase();\nlet caRole = '58860d1bc6887053b5978bb3';\n\nlet caScript = yield Script.fetch('check_unique_params', req.application.id);\ncaScript.data = {\n  username: data.username,\n  name: data.name,\n  role: 'contragents'\n};\ncaScript.req = req;\nyield caScript.run()\n  .then(result =\u003e {\n    if (result instanceof Error) throw new Error(400, 'Checking contragent unique error!');\n  });\n\n\nlet subCaScript = yield Script.fetch('check_unique_params', req.application.id);\nsubCaScript.data = {\n  username: data.subcontragentUsername,\n  role: 'subcontragents'\n};\nsubCaScript.req = req;\nyield subCaScript.run()\n  .then(result =\u003e {\n    if (result instanceof Error) throw new Error(400, 'Checking subcontragent unique error!');\n  });\n\n\nlet password = Math.round(Math.random() * (999999 - 129899) + 129899).toString();\n\nlet userSys = new User({username: data.username, role: caRole, type: \"oauth\"},\n                       req.application.id);\nuserSys.password = password;\nyield userSys.save();\n\nlet caUsername = data.username;\n\nlet notify = yield Service.fetch('notify', req.application.id);\nnotify.data = {password, email:[{email: caUsername}]};\n\n\n\nlet res = yield notify.request('password_gen', req);\n\n\ndelete data.username;\n\nlet newContragent = {user_id: userSys.id, email: userSys.username};\nObject.assign(newContragent, data);\n\nlet usersTable = yield Table.fetch('contragents', req.application.id);\nlet user = yield usersTable.create(newContragent);\n\n\nconst createNewScaScript = yield Script.fetch('create_new_sca', req.application.id);\ncreateNewScaScript.data = {username: data.subcontragentUsername, password: data.subcontragentPassword, contragent_id: userSys.id};\ncreateNewScaScript.req = req;\nlet sca = yield createNewScaScript.run();\n\n\nlet subcontragentPassword = data.subcontragentPassword;\n\n// для контрагента\nlet message = 'У вашего представителя новый пароль в системе: ' + subcontragentPassword;\nlet subject = 'Новый пароль у вашего представителя';\nnotify.data = {subject, email:[{email: caUsername}], message};\nyield notify.request('subcontragent_psw', req);\n\n// для представителя\nmessage = 'У вас новый пароль в системе: ' + subcontragentPassword;\nsubject = 'Новый пароль';\nnotify.data = {subject, email:[{email: data.subcontragentUsername}], message};\nyield notify.request('subcontragent_psw', req);\n\n\nreturn done({data: {contragent: user, subcontragent: sca.data}});\n"
  },
  "name": "create_new_ca",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "597b4c487c18e31a6c8fa4b4"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт изменения пароля для контрагентов и их представителей.\n * Изменять пароль может только администратор\n *\n * @param {string} username - логин пользователя системы\n * @param {string} role - роль пользователя в системе\n */\n\nlet adminRole = '58808abccf1f550f22a8c02a';\n\nif(!data.username || req.user.role.id != adminRole || !data.role) {\n  throw new Error(404, 'Something is going wrong!');\n}\n\nlet role;\nswitch (data.role) {\n  case 'contragent':\n    role = '58860d1bc6887053b5978bb3';\n    break;\n\n  case 'subcontragent':\n    role = '5988108288955d4a0dc7d644';\n    break;\n}\n\nif (!role) { throw new Error(404, 'Incorrect agent role'); }\n\nlet userSys = yield User.find({username: data.username, role: role}, {}, req.application.id);\n\nlet password = Math.round(Math.random() * (999999 - 129899) + 129899).toString();\n\nlet notify = yield Service.fetch('notify', req.application.id);\nnotify.data = {password, email:[{email: data.username}]};\nlet res = yield notify.request('password_gen', req);\nuserSys.password = password;\n\nyield userSys.save();\n\nreturn done('Password send!');\n"
  },
  "name": "password_gen",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "589c4de8d222b80a819c892b"
  },
  "name": "notify",
  "type": "Service",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "host": "localhost",
    "port": "4302",
    "routes": {
      "email_verify": {
        "params": {
          "to": "{$email}",
          "subject": "Код подтверждения смены электронной почты",
          "message": "\u003ca href=\"{$verification_link}\"\u003e{$verification_link}\u003c/a\u003e"
        },
        "name": "email_verify",
        "route": "email",
        "method": "POST"
      },
      "sms_auth": {
        "name": "sms_auth",
        "route": "sms",
        "method": "POST",
        "params": {
          "message": "GMOJI code: {$code}",
          "to": "{$to}"
        }
      },
      "subcontragent_psw": {
        "name": "subcontragent_psw",
        "route": "email",
        "method": "POST",
        "params": {
          "message": "{$message}",
          "subject": "{$subject}",
          "to": "{$email}"
        }
      },
      "call_back": {
        "name": "call_back",
        "route": "email",
        "method": "POST",
        "params": {
          "message": "Поступил заказ на обратный звонок. \u003cbr /\u003e\nКод Gmoji: {$gponCode} \u003cbr /\u003e\nНазвание товара: {$productName} \u003cbr /\u003e\nИмя: {$userName} \u003cbr /\u003e\nТелефон: {$userPhone} \u003cbr /\u003e\nСообщение: {$message} \u003cbr /\u003e",
          "subject": "Заказ на обратный звонок",
          "to": "{$to}",
          "bcc": "orders@gmoji.world"
        }
      },
      "gpon_activating_ban": {
        "name": "gpon_activating_ban",
        "route": "email",
        "method": "POST",
        "params": {
          "to": "{$email}",
          "subject": "Попытка взломать Gpon!",
          "message": "Название контрагента: {$contragent} \u003cbr /\u003e\nДата: {$date} \u003cbr /\u003e\nПричина блокировки: {$reason} \u003cbr /\u003e"
        }
      },
      "password_gen": {
        "name": "password_gen",
        "route": "email",
        "method": "POST",
        "params": {
          "message": "Ваш новый пароль: {$password}",
          "subject": "Генерация пароля",
          "to": "{$email}"
        }
      },
      "sms_reset_psw": {
        "name": "sms_reset_psw",
        "route": "sms",
        "method": "POST",
        "params": {
          "message": "Ваш код для восстановления пароля: {$code}",
          "to": "{$to}"
        }
      },
      "sms_verify": {
        "route": "sms",
        "method": "POST",
        "name": "sms_verify",
        "params": {
          "message": "Ваш код для регистрации: {$code}",
          "to": "{$to}"
        }
      },
      "sms_auth_first": {
        "params": {
          "to": "{$to}",
          "message": "GMOJI code: {$code} - ваш код действителен 2 минуты."
        },
        "method": "POST",
        "route": "sms",
        "name": "sms_auth_first"
      }
    },
    "rules": {
      "all": {
        "access": [
          "send"
        ]
      },
      "public": {
        "access": []
      }
    },
    "params": {
      "email": {
        "smtp": {
          "host": "smtp.yandex.ru",
          "port": 465.0,
          "secure": true,
          "auth": {
            "user": "notifications@gmoji.world",
            "pass": "notifications321"
          }
        },
        "name": "Gmoji",
        "email": "notifications@gmoji.world"
      },
      "sms": {
        "smsc": {
          "username": "Gmoji",
          "password": "Gmoji 2017"
        }
      }
    }
  }
}
{
  "_id": {
    "$oid": "59ba62178e8c9a021d48dbaf"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт обновления профиля мобильного пользователя\n *\n * 1 Запрос на смену логина для получения кода верификации\n * @param {string} newUsername - новый логин пользователя\n *\n * 2 Запрос на обновление профиля с кодом верификации\n * @param {string} newUsername - новый логин пользователя\n * @param {string} code - код верификации\n * @param {string} email - новый email пользователя\n * @param {string} birthdate - новая дата рождения пользователя\n * @param {string} sex - новый пол пользователя\n * @param {string} city - новый город пользователя\n * @param {string} name - новое имя пользователя\n *\n * 3 Запрос на смену обновление профиля без кода верификации\n * @param {string} email - новый email пользователя\n * @param {string} birthdate - новая дата рождения пользователя\n * @param {string} sex - новый пол пользователя\n * @param {string} city - новый город пользователя\n * @param {string} name - новое имя пользователя\n */\n\ndelete data.phone;\ndelete data.username;\n\nfunction inUse() {\n  return done({\n    message: 'Phone already in use',\n    statusCode: 400\n  });    \n};\n\nfunction success() {\n  return done({\n    message: 'Profile successfully updated',\n    statusCode: 200\n  });\n};\n\nconsole.log('User Id:', req.user.id);\nconsole.log('User Type:', req.user.type);\nconsole.log('Data:\\n', data);\nlet mobileUserRole = \"58b40f669154c320f9831bfa\";\nif (data.newUsername \u0026\u0026 !data.code) {\n  let userSys = yield User.find({id: req.user.id, role: mobileUserRole, type: req.user.type}, {}, req.application.id);\n  if (!userSys) { throw new Error(404, 'User not found'); }\n\n  let newUserSys = yield User.find({username: data.newUsername, role: mobileUserRole, type: 'oauth'},{}, req.application.id);\n  if (newUserSys) { return inUse() }\n\n  let usersTable = yield Table.fetch('users', req.application.id);\n  let user = yield usersTable.find({phone: data.newUsername}).catch(e =\u003e ({ data: null }));\n  if (user.data) { return inUse() }\n\n  let code = Math.round(Math.random() * (9999 - 1298) + 1298);\n  let verificationCodesTable = yield Table.fetch('verification_codes', req.application.id);\n\n  let verificationCode = yield verificationCodesTable.find({username: data.newUsername})\n    .catch(e =\u003e (console.error(e), { data: null }));\n  if (!verificationCode.data) {\n    yield verificationCodesTable.create({username: data.newUsername, code: code});\n  } else {\n    yield verificationCode.data.update({code: code});\n  }\n\n  console.log('Code', code);\n  let notify = yield Service.fetch('notify', req.application.id);\n  notify.data = {to:[{number: data.newUsername}], code: code};\n  yield notify.request('sms_verify', req);\n\n  return done({\n    message: 'SMS has been sent!',\n    statusCode: 200\n  });\n}\n\nif (data.newUsername \u0026\u0026 data.code) {\n  let verificationCodesTable = yield Table.fetch('verification_codes', req.application.id);\n  let verificationCode = yield verificationCodesTable.find({username: data.newUsername, code: data.code})\n    .catch(e =\u003e (console.error(e), { data: null }));\n\n  if (!verificationCode.data) {\n    return done({\n      message: 'Code not found',\n      statusCode: 404\n    });\n  }\n\n  yield verificationCodesTable.remove({id: verificationCode.data.id});\n\n  let inUse = false;\n  let newUserSys = yield User.find({username: data.newUsername, role: mobileUserRole, type: 'oauth'},\n                                   {}, req.application.id);\n  if (newUserSys) { return inUse(); }\n\n  let usersTable = yield Table.fetch('users', req.application.id);\n  let user = yield usersTable.find({phone: data.newUsername}).catch(e =\u003e ({ data: null }));\n  if (user.data) { return inUse(); }\n\n  let userSys = yield User.find({id: req.user.id, role: mobileUserRole, type: req.user.type}, {}, req.application.id);\n\n  if (!userSys) { throw new Error(404, 'User not found'); }\n\n  if (userSys.type \u0026\u0026 userSys.type == 'oauth') { yield userSys.update({username: data.newUsername}); }\n\n  data.phone = data.newUsername;\n  delete data.newUsername;\n  delete data.code;\n}\n\nif (!data.newUsername \u0026\u0026 !data.code) {\n  let contains = ['birthdate','sex','email','city','name', 'phone'].some((field) =\u003e {\n    return data[field];\n  });\n\n  console.log('Contains:', contains);\n  if (!contains) { return success(); }\n\n  let userSys = yield User.find({id: req.user.id, role: mobileUserRole, type: req.user.type}, {}, req.application.id);\n  console.log('User Sys:\\n', userSys);\n  if (!userSys) { throw new Error(404, 'User not found'); }\n\n  let usersTable = yield Table.fetch('users', req.application.id);\n  let user = yield usersTable.find({user_id: userSys.id}).catch(e =\u003e ({ data: null }));\n  if (!user.data) {\n    return done({\n      message: 'User profile not found',\n      statusCode: 404\n    });\n  }\n\n  if (user.data.email \u0026\u0026 data.email \u0026\u0026 user.data.email == data.email) {\n    delete data.email;\n  }\n\n  let row = {};\n  if (data.email) {\n    function emailInUse() {\n      return done({\n        message: 'Email already in use',\n        statusCode: 400\n      });\n    };\n\n    let userSysEmail = yield User.find({username: data.email, role: mobileUserRole, type: 'oauth'},\n                                       {}, req.application.id);\n    if (userSysEmail) { return emailInUse(); }\n\n    let userByEmail = yield usersTable.find({email: data.email}).catch(e =\u003e ({ data: null }));\n    if (userByEmail.data) { return emailInUse(); }\n\n    row.email = data.email;\n  }\n\n  if (data.phone) { row.phone = data.phone; }\n  if (data.birthdate) { row.birthdate = data.birthdate; }\n  if (data.sex) { row.sex = data.sex; }\n  if (data.city) { row.city = data.city; }\n  if (data.name) { row.name = data.name; }\n  \n  console.log('Row:\\n', row);\n\n  let updatedRow = yield user.data.update(row);\n  \n  console.log('Updated Row:\\n', updatedRow);\n  return success();\n}\n"
  },
  "name": "edit_profile_mobile",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59c242266c6f2e0226e10a58"
  },
  "name": "excel_exporter",
  "type": "Service",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {},
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "send"
        ]
      }
    },
    "routes": {
      "export_xls": {
        "params": {
          "data": "{$data}",
          "contractor_name": "{$contractor_name}"
        },
        "method": "POST",
        "route": "export",
        "name": "export_xls"
      }
    },
    "port": "4303",
    "host": "localhost"
  }
}
{
  "_id": {
    "$oid": "59c248db6c6f2e0226e10a8f"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт гашения сертификата\n *\n * @param {string} certificate_id - id выбранного сертификата\n * @param {number} pin\n * @param {string} store_id - id выбранного магазина\n *                           \n *                           \n */\n\nif (!data.certificate_id \u0026\u0026 !data.store_id) { throw new Error(400, 'Certificate or store required'); }\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst subcontragentRole = '5988108288955d4a0dc7d644';\nconst adminRole = '58808abccf1f550f22a8c02a';\nconst cashStatus = '598d9bb147217f28ba69e0fc';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nconst certificateCashingTable = yield Table.fetch('certificate_cashing', req.application.id);\n\n\nlet cashStory = {};\nlet certificate;\nlet filter = {\n  id: data.certificate_id,\n  status: activeStatus\n};\n\n/**\n * Гашение контрагента\n */\n\nif (req.user.role.id == contragentRole \u0026\u0026 data.pin) {\n  const contragentsTable = yield Table.fetch('contragents', req.application.id);\n\n  let contragent = yield contragentsTable.find({user_id: req.user.id})\n    .catch(e =\u003e (console.error(e), { data: null }));\n\n  filter.pin = data.pin,\n  filter.user_id = contragent.data.user_id,\n  certificate = yield certificatesTable.find(filter).catch(e =\u003e (console.error(e), { data: null }));\n\n  if (!certificate.data) { throw new Error(400, 'Certificate not found'); }\n\n  Object.assign(cashStory, {\n    product_id: certificate.data.product,\n    contragent_id: req.user.id,\n    certificate_id: data.certificate_id,\n    cashing_place: data.store_id,\n  });\n}\n\n/**\n * Гашение представителя контрагента\n */\n\nif (req.user.role.id == subcontragentRole \u0026\u0026 data.pin) {\n  const subcontragentsTable = yield Table.fetch('subcontragents', req.application.id);\n \n  let subcontragent = yield subcontragentsTable.find({user_id: req.user.id})\n    .catch(e =\u003e (console.error(e), { data: null }));\n\n  filter.pin = data.pin,\n  filter.user_id = subcontragent.data.contragent_id,\n  certificate = yield certificatesTable.find(filter).catch(e =\u003e (console.error(e), { data: null }));\n\n  if (!certificate.data) { throw new Error(400, 'Certificate not found'); }\n\n  Object.assign(cashStory, {\n    product_id: certificate.data.product,\n    subcontragent_id: subcontragent.data.user_id,\n    contragent_id: subcontragent.data.contragent_id,\n    certificate_id: data.certificate_id,\n    cashing_place: data.store_id,\n  });\n}\n\n/**\n * Гашение за админа\n */\n\nif (req.user.role.id == adminRole \u0026\u0026 data.pin) {\n  filter.pin = data.pin,\n  certificate = yield certificatesTable.find(filter)\n    .catch(e =\u003e (console.error(e), { data: null }));\n\n  if (!certificate.data) { throw new Error(400, 'Certificate not found'); }\n\n  const storesTable = yield Table.fetch('stores', req.application.id);\n  let store = yield storesTable.find({id: data.store_id}).catch(e =\u003e (console.error(e), { data: null }));\n  if (!store.data) { throw new Error(404, 'Store not found'); }\n\n  Object.assign(cashStory, {\n    product_id: certificate.data.product,\n    contragent_id: store.data.user_id,\n    certificate_id: data.certificate_id,\n    cashing_place: data.store_id,\n  });\n}\n\nlet result = yield certificate.data.update({status: cashStatus, deactivation_date: Date.now()});\nconsole.log('Result:\\n', result);\n\nconst paytureOrdersTable = yield Table.fetch('payture_orders', req.application.id);\nconsole.log('Order id', result.order_id);\nlet payOrder = yield paytureOrdersTable.find({order_id: result.order_id})\n  .catch(e =\u003e (console.error(e), { data: null }));\nconsole.log('Pay order:\\n', payOrder);\n\nObject.assign(cashStory, {cashing_price: payOrder.data.amount / 100});\nconsole.log('Cash Story:\\n', cashStory);\n\nyield certificateCashingTable.create(cashStory);\n\nreturn done(result);\n"
  },
  "name": "cash_certificate",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59cbc2afd5fc3634c79b98c9"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Поиск джипона для гашения\n\u0009@param code - code джипона\n*/\nif (!data.code) throw new Error(400, 'Bad request!');\nconst subcontragentsTable = yield Table.fetch('subcontragents', req.application.id);\nconst contragentsTable = yield Table.fetch('contragents', req.application.id);\nconst certificateTable = yield Table.fetch('certificates', req.application.id);\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst subcontragentRole = '5988108288955d4a0dc7d644';\nconst adminRole = '58808abccf1f550f22a8c02a';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nlet certificate;\n\nlet options = {  };\nif (data.limit) options.limit = data.limit;\nif (data.page) options.skip = data.page * data.limit || 0;\nif (data.sort) options.sort = data.sort;\n\n\nif(req.user.role.id == contragentRole) {\n  options.select = ['code', 'status', 'product', 'name', 'buy_date', 'end_sale_date'];\n  certificate = yield certificateTable.findAll({ code: { $regex: data.code, $options: 'i' }, user_id: req.user.id, status: activeStatus}, options);\n}\n\nif (req.user.role.id == subcontragentRole) {\n\n  options.select = ['code', 'status', 'product', 'name'];\n  let subcontragent = yield subcontragentsTable.find({user_id: req.user.id}).catch(e =\u003e (console.error(e), { data: null }));\n\n  certificate = yield certificateTable.findAll({ code: { $regex: data.code, $options: 'i'}, user_id: subcontragent.data.contragent_id,\n   status: activeStatus}, options);\n}\n\nif (req.user.role.id == adminRole) {\n  options.select = ['code', 'status', 'product', 'name', 'buy_date', 'end_sale_date'];\n  certificate = yield certificateTable.findAll({ code: { $regex: data.code, $options: 'i' }, status: activeStatus}, options);\n}\n\nreturn done(certificate.data);\n"
  },
  "name": "find_gpon_for_cash",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59cfa6453db85407254a0cdd"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "if (data.productId) {\n    const deleteStatus = '598d9ff947217f28ba69e10a';\n    const adminRole = '58808abccf1f550f22a8c02a';\n    const caRole = '58860d1bc6887053b5978bb3';\n    const gponActiveStatus = '598d9bac47217f28ba69e0f5';\n    const topCategoryId = '58e5f191d351f81cc3fa6a0a';\n\n\n    let productsTable = yield Table.fetch('products', req.application.id);\n    let product = yield productsTable.find({id: data.productId}).catch(e =\u003e (console.log(e), {data: null}));\n    if(((product.data.user_id.length \u003e 1 || product.data.user_id.length == 1) \u0026\u0026 req.user.role.id == adminRole)\n        || (product.data.user_id.length == 1 \u0026\u0026 req.user.role.id == caRole \u0026\u0026 req.user.id == product.data.user_id[0])) {\n\n        let certificateTable = yield Table.fetch('certificates', req.application.id);\n        let activeGpon = yield certificateTable.find({status: gponActiveStatus, product: data.productId}).catch(e =\u003e (console.log(e), {data: null}));\n        if(activeGpon.data) throw new Error(400, 'Product has active Gpons');\n\n        let ind = product.data.categories.findIndex(category =\u003e {\n            return category.id.toString() == topCategoryId;\n        });\n        if (ind \u003e= 0) product.data.categories.splice(ind, 1);\n\n        let result = yield product.data.update({status: deleteStatus, categories: product.data.categories});\n        const couponsTable = yield Table.fetch('coupons', req.application.id);\n        yield couponsTable.updateMany({product: data.productId, status: gponActiveStatus},{status: deleteStatus});\n\n        return done(result);\n    } else throw new Error(403, 'Cant delete product');\n} throw new Error(404, 'Product not found');\n"
  },
  "name": "soft_delete_products",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59d0f67d3db85407254a0cf1"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "if(data.storeId) {\n  const deleteStatus = '598d9ff947217f28ba69e10a';\n  let storesTable = yield Table.fetch('stores', req.application.id);\n  let store = yield storesTable.find({id: data.storeId}).catch(e =\u003e (console.error(e), {data: null}));\n  let result = yield store.data.update({status: deleteStatus});\n  return done(result);\n}\n"
  },
  "name": "soft_delete_store",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59d25d6e3db85407254a1368"
  },
  "type": "Script",
  "options": {
    "code": "/*\nif (!data || !data.data || !data.data.id || !data.data.output_price) {\n  throw new Error(400, 'Incorrect data');\n}\n\nconst outputPriceHistoryTable = yield Table.fetch('product_output_price_history', req.application.id);\nif (req.method == 'POST') {\n  yield outputPriceHistoryTable.create({\n    user_id: req.user.id,\n    output_price: data.data.output_price,\n    product_id: data.data.id\n  });\n} else if (req.method == 'PUT') {\n  if (!data.newData || !data.newData.output_price) {\n    throw new Error(400, 'Incorrect data');\n  }\n\n  if (data.newData.output_price == data.data.output_price) { return done(); }\n\n  yield outputPriceHistoryTable.create({\n    user_id: req.user.id,\n    output_price: data.newData.output_price,\n    product_id: data.data.id\n  });\n}\n\nreturn done();\n*/",
    "editorOptions": {
      "lineNumbers": true,
      "lineWrapping": true,
      "matchBrackets": true,
      "autoCloseBrackets": true,
      "autoRefresh": true,
      "mode": "javascript"
    },
    "rules": {
      "all": {
        "access": [
          "run"
        ]
      },
      "public": {
        "access": []
      }
    }
  },
  "name": "product_output_price_change_trigger",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59de0f58f6d6b47705fb9f59"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Технический скрипт для установки определенным записям статсу активен\n */\n\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\nconst certificatesTable = yield Table.fetch('users', req.application.id);\n\nlet certificates = yield certificatesTable.findAll({status: {$exists: false}});\n\nyield certificates.data.map(function *(certificate) {\n  yield certificate.update({status: activeStatus});\n});\n\nreturn done();\n"
  },
  "name": "technical_status_implemetation",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e4bdc8505b9850a6758bb1"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const activeStatus = '598d9bac47217f28ba69e0f5';\nconst cashStatus = '598d9bb147217f28ba69e0fc';\nlet result = [];\nconst usersTable = yield Table.fetch('users', req.application.id);\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\n\nlet params = {\n\u0009status: activeStatus,\n};\n\nif (data.name) params.name =  { $regex: data.name, $options: 'i' };\nif (data.phone) params.phone = { $regex: data.phone, $options: 'i' };\n\nlet options = {};\nif (data.limit) options.limit = data.limit;\nif (data.page) options.skip = data.page * data.limit || 0;\nif (data.sort) options.sort = data.sort;\n\n\n\nlet users = yield usersTable.findAll(params, options);\n\n\nyield users.data.map(function* (user) {\n\u0009let buyedGpons = yield certificatesTable.findAll({buyer_id: user.user_id});\n\u0009let cashGpons = buyedGpons.data.filter(gpon =\u003e {\n\u0009\u0009return gpon.status.id == cashStatus;\n\u0009});\n\u0009Object.assign(user, {buyed_gpons_count: buyedGpons.data.length, cash_gpons_count: cashGpons.length});\n});\n\nreturn done(users.data);\n"
  },
  "name": "get_users_list",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e5c041505b9850a6758f83"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "if (!data.userId) throw new Error(400, ' No params!');\n\nconst usersTable = yield Table.fetch('users', req.application.id);\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nconst certificateCashingTable = yield Table.fetch('certificate_cashing', req.application.id);\nconst paytureOrdersTable = yield Table.fetch('payture_orders', req.application.id);\n\nlet options = {};\nif (data.limit) options.limit = data.limit;\nif (data.page) options.skip = data.page * data.limit || 0;\nif (data.sort) options.sort = data.sort;\n\n\nlet user = yield usersTable.find({user_id: data.userId}).catch(e =\u003e {throw new Error(404, 'User not found!')});\n\nlet certificates = yield certificatesTable.findAll({buyer_id: data.userId}, options);\n\n\n\nyield certificates.data.map(function* (certificate) {\n\u0009let isCash = false;\n\u0009let cash = yield certificateCashingTable.find({certificate_id: certificate.id}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009if (cash.data) isCash = true;\n\n\u0009let order = yield paytureOrdersTable.find({order_id: certificate.order_id}).catch(e =\u003e {throw new Error(404, 'Order not found!')});\n\n\u0009Object.assign(certificate, {isCash, price: order.data.amount / 100});\n\n});\n\nreturn done({user: user.data, certificates: certificates.data});"
  },
  "name": "get_user_info",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a02bd33c180901b8cd068a0"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "\n// user.find (аргументы посмотреть тут и как обычно)\n/**\n  Редактирование контрагента и представителя\n   @param - data.username\n   @param - data.password\n   @param - contragent_id - id системного пользователя\n*/\n\n\nif (!data.contragent_id) {\n  throw new Error(400, 'Enter correct data!');\n}\n\nif (data.username) data.username = data.username.toLowerCase();\n\n\n\nlet subcontragent;\nconst subcontragentsTable = yield Table.fetch('subcontragents', req.application.id);\nsubcontragent = yield subcontragentsTable.find({contragent_id: data.contragent_id}).catch(e =\u003e (console.error(e), {data: null}));\n\nlet userSys = yield User.find({id: subcontragent.data.user_id}, {}, req.application.id); // это представитель\n\nif (data.username) {\nif (!userSys) {\n\u0009const createScaScript = yield Script.fetch('create_new_sca', req.application.id);\n\u0009createScaScript.req = req;\n\u0009createScaScript.data = {username: data.username, password: data.password, contragent_id: data.contragent_id};\n\u0009subcontragent = yield createScaScript.run();\n} else {\n\n\u0009userSys.username = data.username;\n\u0009yield subcontragent.data.update({email: data.username});\n}\n}\nif (!userSys) throw new Error(400, 'Need to create subcontragent');\nif (data.password) {\n\u0009userSys.password = data.password;\n}\n\nyield userSys.save();\n\n\nreturn done({data: subcontragent.data});\n\n"
  },
  "name": "edit_sca",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a0aad8cec69d90742bae4d7"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "if (data.type == 'create') {\n\u0009data.data.categories.every(category =\u003e {\n\u0009\u0009if (category.is_adult === true) {\n\u0009\u0009\u0009let\u0009updateData = {is_adult: true};\n\u0009\u0009\u0009data.newData = Object.assign(data.newData, updateData);\n\u0009\u0009\u0009return false;\n\u0009\u0009} else {\n\u0009\u0009\u0009let\u0009updateData = {is_adult: false};\n\u0009\u0009\u0009data.newData = Object.assign(data.newData, updateData);\n\u0009\u0009}\n\u0009}); \u0009\n}\n  return done();\n"
  },
  "name": "set_adult_trigger",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a0afd7eec69d90742bae78a"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "\nconst usersTable = yield Table.fetch('users', req.application.id);\nlet user = yield usersTable.find({user_id: req.user.id}).catch(e =\u003e (console.log(e), {data: null}));\n\nif (user.data.birthdate === null || user.data.birthdate === undefined) return done(false);\nif (user.data.birthdate == 0) return done(true);\n\n \nif (new Date().getFullYear() - new Date(user.data.birthdate).getFullYear() == 18) {\n\u0009if (new Date().getMonth() - new Date(user.data.birthdate).getMonth() \u003e 0) {\n\u0009\u0009return done(true);\n\u0009} \n\n\u0009if (new Date().getMonth() - new Date(user.data.birthdate).getMonth() == 0) {\n\u0009\u0009if (new Date().getDate() - new Date(user.data.birthdate).getDate() \u003c 0) {\n\u0009\u0009\u0009return done(false);\n\u0009\u0009} else {\n\u0009\u0009\u0009return done(true);\n\u0009\u0009}\n\u0009} \n\n\u0009if (new Date().getMonth() - new Date(user.data.birthdate).getMonth() \u003c 0) {\n\u0009\u0009return done(false);\n\u0009} \n\n}\n\nif (new Date().getFullYear() - new Date(user.data.birthdate).getFullYear() \u003c 18) {\n\u0009return done(false);\n}\n\nif (new Date().getFullYear() - new Date(user.data.birthdate).getFullYear() \u003e 18) {\n\u0009return done(true);\n}\n"
  },
  "name": "check_is_adult",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a8d2da6265be1072082756d"
  },
  "name": "administrators",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "fullname": {
        "type": "string",
        "name": "fullname"
      },
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5b45b4d9a717111871bea198"
  },
  "name": "product_store_cards",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "adapter": "MongoDB",
    "fields": {
      "status": {
        "name": "status",
        "type": "referer",
        "populate": false,
        "ref": "598d9a4747217f28ba69e0f3",
        "required": true
      },
      "product_price": {
        "name": "product_price",
        "type": "number"
      },
      "product_name": {
        "name": "product_name",
        "type": "string"
      },
      "contragent_card_id": {
        "name": "contragent_card_id",
        "type": "referer",
        "populate": false,
        "ref": "5a8acc1b265be1072082751f"
      },
      "store_id": {
        "name": "store_id",
        "type": "referer",
        "populate": false,
        "ref": "5876420595ed3c0c59b14606",
        "required": true
      },
      "product_id": {
        "name": "product_id",
        "type": "referer",
        "populate": false,
        "ref": "58973d924802c138d75d91e6",
        "required": true
      }
    },
    "rules": {
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      },
      "public": {
        "access": []
      }
    },
    "params": {
      "timestamps": true
    },
    "triggers": ""
  }
}
{
  "_id": {
    "$oid": "592d4c765187d01f677a1719"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "try {\n  let Products = yield Table.fetch('products', req.application.id);\n  let products = yield Products.findAll();\n  let Certificates = yield Table.fetch('certificates', req.application.id);\n\n  products.data = yield products.data.map(function *(product) {\n    let certificates = yield Certificates.findAll({product: product.id});\n    console.log(`product ${product.name} certificates:\\n`, certificates.count);\n    product = Object.assign(product, {certificates_count: certificates.data.length});\n    return product;\n  });\n\n  return done(products);  \n} catch(error) {\n  done(new Error(error.stack));\n}"
  },
  "name": "product_list_with_certificate_count",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "598d9a4747217f28ba69e0f3"
  },
  "name": "statuses",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "rules": {
      "public": {
        "access": [
          "list",
          "view"
        ]
      },
      "all": {
        "access": [
          "list",
          "view"
        ]
      }
    },
    "fields": {
      "name": {
        "type": "string",
        "name": "name"
      },
      "name_en": {
        "type": "string",
        "name": "name_en"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "59915a2f1a914d7dc7e6f11b"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const validator = yield Script.fetch('entity_validator', req.application.id);\nvalidator.req = req;\nvalidator.data = {categoryName: data.name};\nlet validation = yield validator.run();\nif (!validation) throw new Error(400, 'Name is not unique!');\n\nlet categoryTable = yield Table.fetch('product_categories', req.application.id);\nlet result = yield categoryTable.create(data);\nif (!result) throw new Error(400, 'Cant create category!');\nreturn done(result);\n\n"
  },
  "name": "create_category",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5996d9111a914d7dc7e71141"
  },
  "name": "certificate_cashing",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "adapter": "MongoDB",
    "fields": {
      "cashing_name": {
        "name": "cashing_name",
        "type": "string"
      },
      "cashing_price": {
        "name": "cashing_price",
        "type": "number"
      },
      "product_id": {
        "name": "product_id",
        "type": "referer",
        "populate": false,
        "ref": "58973d924802c138d75d91e6"
      },
      "subcontragent_id": {
        "name": "subcontragent_id",
        "type": "string"
      },
      "contragent_id": {
        "name": "contragent_id",
        "type": "string",
        "populate": false,
        "ref": "5876419795ed3c0c59b14601"
      },
      "cashing_place": {
        "name": "cashing_place",
        "type": "referer",
        "populate": false,
        "ref": "5876420595ed3c0c59b14606"
      },
      "certificate_id": {
        "name": "certificate_id",
        "type": "referer",
        "populate": false,
        "ref": "587641c295ed3c0c59b14603"
      },
      "phone": {
        "name": "phone",
        "type": "string"
      }
    },
    "rules": {
      "all": {
        "access": []
      },
      "public": {
        "access": []
      }
    },
    "params": {
      "timestamps": true
    },
    "triggers": ""
  }
}
{
  "_id": {
    "$oid": "59b1501abc280b12d32b98ae"
  },
  "name": "certificate_giving_history",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "certificate": {
        "ref": "587641c295ed3c0c59b14603",
        "populate": false,
        "type": "referer",
        "name": "certificate"
      },
      "giver_id": {
        "type": "string",
        "name": "giver_id"
      },
      "status_updated_at": {
        "type": "date",
        "name": "status_updated_at"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "59b24e0dbc280b12d32b98c7"
  },
  "name": "subcontragents",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "user_id": {
        "required": true,
        "type": "string",
        "name": "user_id"
      },
      "email": {
        "required": false,
        "type": "string",
        "name": "email"
      },
      "contragent_id": {
        "ref": "5876419795ed3c0c59b14601",
        "populate": {
          "filter": "",
          "select": []
        },
        "required": true,
        "type": "string",
        "name": "contragent_id"
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": false,
        "required": true,
        "type": "referer",
        "name": "status"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "59b7c32b8e8c9a021d48d523"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт формирования списка сертификатов юзера,\n * которыми он владеет\n */\n\nconst deletedStatus = '598d9ff947217f28ba69e10a';\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nlet boughtGpons = yield certificatesTable.findAll({buyer_id: req.user.id, status: {$ne: deletedStatus}});\n\nlet boughtGponIds = [];\nboughtGponIds = boughtGpons.data.map(gpon =\u003e gpon.id);\n\n// История дарения сертификатов\nconst certificateGivingTable = yield Table.fetch('certificate_giving_history', req.application.id);\nlet sentGponsHistory = yield certificateGivingTable.findAll({\n  giver_id: req.user.id,\n//  certificate: {$in: boughtGponIds}\n});\n\n// Находим отправленные сертификаты\nlet sentGponIds = sentGponsHistory.data.map(row =\u003e row.certificate.toString());\n\n// Очищаем купленные от отправленных\nboughtGpons.data = boughtGpons.data.filter(gpon =\u003e { \n   if (!~sentGponIds.indexOf(gpon.id.toString())) { return gpon; }\n   return false;\n});\n\n// История получения сертификатов\nconst certificateOwningTable = yield Table.fetch('certificate_owning_history', req.application.id);\nlet ownedGponsHistory = yield certificateOwningTable.findAll({owner_id: req.user.id}); \n\n// Находим id полученных сертификатов\nlet ownedGponIds = ownedGponsHistory.data.map(row =\u003e row.certificate.toString());\n\n// Очищаем id полученных сертификатов, которые приняты и отправлены\nownedGponIds = ownedGponIds.filter(gponId =\u003e {\n   if (!~sentGponIds.indexOf(gponId)) { return gponId; }\n   return false;\n});\n\n// Находим полученные сертификаты\nlet ownedGpons = yield certificatesTable.findAll({id: {$in: ownedGponIds}, status: {$ne: deletedStatus}});\nownedGpons = ownedGpons.data.map(ownedGpon =\u003e {\n  let match = ownedGponsHistory.data.findIndex(item =\u003e item.certificate == ownedGpon.id);\n\n  if (~match) { ownedGpon.status_updated_at = ownedGponsHistory.data[match].status_updated_at; }\n\n  return ownedGpon;\n});\n\n// Формируем общий список имеющихся сертификатов из всех источников\nlet myGpons = boughtGpons.data.concat(ownedGpons);\n\nconst checkAdultScript = yield Script.fetch('check_is_adult', req.application.id);\ncheckAdultScript.req = req;\ncheckAdultScript.data = {};\nlet check_adult = yield checkAdultScript.run();\nif (!check_adult) {\n\u0009let notAdultGpons = myGpons.filter(gpon =\u003e {\n\u0009\u0009if (gpon.product.is_adult == false) return gpon;\n\u0009});\n\u0009return done(notAdultGpons);\n}\n\nreturn done(myGpons);\n"
  },
  "name": "get_my_certificates",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59b7c34b8e8c9a021d48d528"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт формирования списка сертификатов юзера,\n * которые он подарил\n */\n\nconst deletedStatus = '598d9ff947217f28ba69e10a';\nconst certGivingTable = yield Table.fetch('certificate_giving_history', req.application.id);\nlet sentGponsHistory = yield certGivingTable.findAll({giver_id: req.user.id});\n\nlet sentGponIds = sentGponsHistory.data.map(gpon =\u003e gpon.certificate.toString());\n\nif (!sentGponIds.length) { return done([]); }\n\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nlet sentGpons = yield certificatesTable.findAll({id: {$in: sentGponIds}, status: {$ne: deletedStatus}});\n\nlet result = [];\nsentGpons.data.map(row =\u003e {\n  if (!~result.findIndex(item =\u003e item.id == row.id)) {\n    result.push(row);\n  }\n});\n\nreturn done(result);\n"
  },
  "name": "get_send_certificates",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59c28a1369222c4b8fcfbc04"
  },
  "name": "trying_cashing_history",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": [
      {
        "pre": true,
        "entity": "59c3661751ddea023696f8cc",
        "type": "update",
        "name": ""
      }
    ],
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "certificate_id": {
        "ref": "587641c295ed3c0c59b14603",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "certificate_id"
      },
      "attempts": {
        "type": "number",
        "name": "attempts"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "59c3661751ddea023696f8cc"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const adminRole = '58808abccf1f550f22a8c02a';\nconst banRole = '59c34d2851ddea023696f860';\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst subcontragentRole = '5988108288955d4a0dc7d644';\nlet notifyService = yield Service.fetch('notify', req.application.id);\n\nlet contragent;\nlet subcontragent;\n\nif (data.newData.attempts \u003e 5 \u0026\u0026 req.user.role.id != adminRole) {\n  const userSys = yield User.find({id: req.user.id}, {}, req.application.id);\n  if (!userSys)  throw new Error(404, 'User not found');\n\n  userSys.role = banRole;\n    yield userSys.save();\n  let sendObj = {\n    date: new Date(),\n    email: 'notifications@gmoji.world', //notifications@gmoji.world\n    reason: 'Попытка активировать джипон более 5 раз!'\n  }\n  if (req.user.role.id == contragentRole) {\n    const contragentsTable = yield Table.fetch('contragents', req.application.id);\n    contragent = yield contragentsTable.find({user_id: req.user.id}).catch(e =\u003e (console.error(e), { data: null }));\n    notifyService.data = Object.assign({reason: sendObj.reason, contragent: contragent.data.name, date: sendObj.date, email:[{email: sendObj.email}]});\n  }\n  if (req.user.role.id == subcontragentRole) {\n\n    const subcontragentsTable = yield Table.fetch('subcontragents', req.application.id);\n    subcontragent = yield subcontragentsTable.find({user_id: req.user.id}, {populate: 'contragent_id'}).catch(e =\u003e (console.error(e), { data: null }));\n    notifyService.data = Object.assign({reason: sendObj.reason, contragent: subcontragent.data.contragent_id.name, date: sendObj.date, email:[{email: sendObj.email}]});\n  }\n\n  let result = yield notifyService.request('gpon_activating_ban', req).catch(err =\u003e done(err));\n  return done('OK');\n}\n"
  },
  "name": "trying_cashing_history_update_trigger",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59c8b46bb85259070a7ebfb6"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const usersTable = yield Table.fetch('users', req.application.id);\nlet user = yield usersTable.find({user_id: req.user.id})\n  .catch(e =\u003e (console.error(e), { data: null }));\n\nif (!user.data.email || !user.data.phone) {\n  return done({\n    statusCode: 404,\n    message: 'Email or phone not found'\n  });\n}\n\nreturn done({\n  statusCode: 200,\n  message: 'Email and phone present'\n});\n"
  },
  "name": "check_mail_and_phone",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59c921c222e2f361131e3420"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "\nlet password = Math.round(Math.random() * (99999999 - 12989999) + 12989999).toString();\n\nconst usersTable = yield Table.fetch('users', req.application.id);\n\nlet user = yield usersTable.find({user_id: req.user.id}).catch(e =\u003e (console.error(e), { data: null }));\nif (!user.data.phone) throw new Error(404, 'Phone not found!');\n\nlet check = yield eWalletCheckUser();\nlet json = JSON.parse(check);\nif (json.Success == \"True\") return done(json);\n\nlet result = yield eWalletRegistration();\nreturn done(result);\n\nfunction* eWalletRegistration() {\n  return new Promise(function(resolve, reject) {\n    request('https://api.gmoji.world/payture/register?buyerId='+ req.user.id +'\u0026password='+ password +'\u0026phone=' + user.data.phone, function (error, response, body) {\n      if (error) reject(err); //https://api.gmoji.world/payture/register?buyerId=\n      resolve(body); \n    })\n  });\n}\n\nfunction* eWalletCheckUser() {\n  return new Promise(function(resolve, reject) {\n    request('https://api.gmoji.world/payture/check?buyerId='+ req.user.id, function (error, response, body) {\n      if (error) reject(err);\n      resolve(body);\n    })\n  });\n}\n\n"
  },
  "name": "ewallet_registration",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59d0f65b3db85407254a0ced"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const adminRole = '58808abccf1f550f22a8c02a';\nif (data.categoryId \u0026\u0026 req.user.role.id == adminRole) {\n  const categoryTopId = '58e5f191d351f81cc3fa6a0a';\n  if (data.categoryId == categoryTopId) throw new Error(400, 'Cant delete category Top!');\n  \n  \n  const deleteStatus = '598d9ff947217f28ba69e10a';\n  const activeStatus = '598d9bac47217f28ba69e0f5';\n  const softDeleteProductScript = yield Script.fetch('soft_delete_products', req.application.id);\n  const productCategoriesTable = yield Table.fetch('product_categories', req.application.id);\n  const productsTable = yield Table.fetch('products', req.application.id);\n\n\n  let category = yield productCategoriesTable.find({id: data.categoryId}).catch(e =\u003e (console.error(e), {data: null}));\n  let products = yield productsTable.findAll({categories: data.categoryId});\n\n  if(products.data) {\n    products.data.map(product =\u003e {\n      if (product.status.id == activeStatus) throw new Error(403, 'Cant delete category');\n    });\n\n    yield products.data.map(function* (product) {\n      softDeleteProductScript.data = {productId: product.id};\n      softDeleteProductScript.req = req;\n      let data = yield softDeleteProductScript.run();\n    });\n  }\n\nlet result = yield category.data.update({status: deleteStatus});\nreturn done(result);\n} throw new Error(404, 'Category not found');\n"
  },
  "name": "soft_delete_category",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a0d9823efe6fd072f3a2ab4"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const contragentRoleId = '58860d1bc6887053b5978bb3';\nlet caRole = yield Role.find({id: contragentRoleId}, {}, req.application.id);\nlet result = {};\nif (caRole.permissions.create_product.all.length == 1) {\n\u0009Object.assign(result, {create_product: true});\n} else Object.assign(result, {create_product: false});\n\nif (caRole.permissions.edit_product.all.length == 1) {\n\u0009Object.assign(result, {edit_product: true});\n} else Object.assign(result, {edit_product: false});\n\nif (caRole.permissions.soft_delete_products.all.length == 1) {\n\u0009Object.assign(result, {delete_product: true});\n} else Object.assign(result, {delete_product: false});\n\nreturn done(result);"
  },
  "name": "get_contragent_product_rules",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a1423079f272c123aacf13d"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "let fileBuffer = yield readWrap(data.file[0].path);\nlet params = {\n  buffer: fileBuffer\n};\nconst csvParser = yield Service.fetch('csv-parser', req.application.id);\ncsvParser.data = params;\nlet result = yield csvParser.request('parse', req).catch(err =\u003e done(err));\nlet resultJSON;\ntry {\n      resultJSON = JSON.parse(result.body);\n  } catch(e) {\n\u0009  throw new Error(500, 'Cant parse response');\n \u0009}\nif (resultJSON.code \u0026\u0026 resultJSON.code \u003e 200) throw new Error(500, 'Server Error')\nreturn done({data: resultJSON});\n\n\nfunction readWrap(path) {\n  return new Promise((resolve,reject) =\u003e {\n    fs.readFile(path, (err, data) =\u003e { // заменить на readStream\n  if (err) reject(err);\n  resolve(data);\n  });\n });\n}\n"
  },
  "name": "csv_parse_start",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a1446469f272c123aacf323"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009На вход [\"Миша\", \"Саша\", \"Маша\"]\n*/\n\nconst deactivatedStatus = '5a144de29f272c123aacf331';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nconst pendingStatus = '5a144d9f9f272c123aacf330';\nconst guidTable = yield Table.fetch('guid', req.application.id);\n// --- validation \nconst couponsTable = yield Table.fetch('coupons', req.application.id);\nlet coupons = yield couponsTable.findAll({status: {$in: [activeStatus, deactivatedStatus]}});\nyield data.fileData.map(function* (c){\n\u0009let ind = coupons.data.findIndex(coupon =\u003e {\n\u0009\u0009return c == coupon.code;\n\u0009});\n\u0009if (ind \u003e= 0 \u0026\u0026 coupon.guid) {\n\u0009\u0009let checkGuid = yield guidTable.find({id: coupon.guid}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009\u0009if (!checkGuid.data) throw new Error(400, 'Coupon already in a system!');\n\u0009\u0009if (checkGuid.data.status == activeStatus) throw new Error(400, 'Coupon already in a system!');\n\u0009} \n});\n// --- validation end\n\n// --- gen guid and first-stage-writing\nlet uidCode = uuid.v4();\nlet newGuid = yield guidTable.create({guid: uidCode, status: pendingStatus});\n\ndata.fileData = data.fileData.map(c =\u003e {\n\u0009return {code: c, guid: newGuid.id, status: pendingStatus};\n});\n\nlet newRows = yield couponsTable.insertMany(data.fileData);\n\nreturn done({guid: newGuid.guid, coupons_count: newRows.data.length});\n\n// NEXT SCRIPT CONFIRM_COUPONS\n"
  },
  "name": "csv_parse_finish",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a1585ee8b1070188272b324"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "\n/**\n\u0009Отдает данные для контрагента, его представителя и админа в локал сторедж\n*/\n\nconst adminRole = '58808abccf1f550f22a8c02a';\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst subcontragentRole = '5988108288955d4a0dc7d644';\nlet result = {};\n\n\nif (req.user.role.id == contragentRole) {\n\u0009const contragentTable = yield Table.fetch('contragents', req.application.id);\n\u0009let contragent = yield contragentTable.find({user_id: req.user.id}).catch(e =\u003e (console.log(e), {data: null}));\n\n\u0009const getProductRulesScript = yield Script.fetch('get_contragent_product_rules', req.application.id);\n\u0009getProductRulesScript.req = req;\n\u0009getProductRulesScript.data = {};\n\u0009let rules = yield getProductRulesScript.run();\n\n\u0009Object.assign(result, {user_id: req.user.id, username: req.user.username,\n\u0009 role: req.user.role.id, user_giftclub_id: contragent.data.id, rules});\n}\n\nif (req.user.role.id == adminRole) {\n\u0009Object.assign(result, {user_id: req.user.id, username: req.user.username,\n\u0009 role: req.user.role.id});\n\n}\n\nif (req.user.role.id == subcontragentRole) {\n\u0009const subcontragentTable = yield Table.fetch('subcontragents', req.application.id);\n\u0009let subcontragent = yield subcontragentTable.find({user_id: req.user.id}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009Object.assign(result, {user_id: req.user.id, username: req.user.username,\n\u0009 role: req.user.role.id, user_giftclub_id: subcontragent.data.id});\n}\nreturn done(result)\n"
  },
  "name": "get_storage_info",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a212d966dc4227345998731"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "\nif (data.type == 'update') {\n\nconst appId = '587640c995ed3c0c59b14600';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\n\u0009// проверять если изменился массив user_id то в сертификаты пихать новый \n\u0009if (data.newData.user_id \u0026\u0026 data.newData.user_id.length \u003e 0) {\n\nif (data.newData.user_id.length \u003e data.data.user_id.length) {\n\u0009\u0009\u0009for (let i = 0; i \u003c data.newData.user_id.length; i++) {\n\u0009\u0009\u0009\u0009if (!~data.data.user_id.indexOf(data.newData.user_id[i])) {\n\u0009\u0009\u0009\u0009\u0009const certificatesTable = yield Table.fetch('certificates', appId);\n\u0009\u0009\u0009\u0009\u0009let certificates = yield certificatesTable.updateMany({status: activeStatus, product: data.data.id},{user_id: data.newData.user_id});\n\u0009\u0009\u0009\u0009\u0009break;\n\u0009\u0009\u0009\u0009}\n\u0009\u0009\u0009}\n\u0009\u0009} else {\n\u0009\u0009\u0009for (let i = 0; i \u003c data.data.user_id.length; i++) {\n\u0009\u0009\u0009\u0009if (!~data.newData.user_id.indexOf(data.data.user_id[i])) {\n\u0009\u0009\u0009\u0009\u0009const certificatesTable = yield Table.fetch('certificates', appId);\n\u0009\u0009\u0009\u0009\u0009let certificates = yield certificatesTable.updateMany({status: activeStatus, product: data.data.id},{user_id: data.newData.user_id});\n\u0009\u0009\u0009\u0009\u0009break;\n\u0009\u0009\u0009\u0009}\n\u0009\u0009\u0009}\n\u0009\u0009}\n\n\n\u0009}\n\u0009\n\n}\n  return done();\n  "
  },
  "name": "edit_ca_list_from_prod_to_gpon_trigger",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a8bebf5265be10720827533"
  },
  "name": "administration_logs",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      }
    },
    "fields": {
      "operation_type": {
        "type": "string",
        "name": "operation_type"
      },
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "table_name": {
        "type": "string",
        "name": "table_name"
      },
      "entity_id": {
        "type": "string",
        "name": "entity_id"
      },
      "updated_fields": {
        "array": true,
        "type": "string",
        "name": "updated_fields"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5addecec44b13f2b038ebc77"
  },
  "name": "email_verification_tokens",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      }
    },
    "fields": {
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "email": {
        "type": "string",
        "name": "email"
      },
      "expiration_date": {
        "type": "date",
        "name": "expiration_date"
      },
      "token": {
        "type": "string",
        "name": "token"
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": false,
        "type": "referer",
        "name": "status"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5ae3316ae0e6b91fe110689c"
  },
  "name": "product_instructions",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "adapter": "MongoDB",
    "fields": {
      "status": {
        "name": "status",
        "type": "referer",
        "populate": false,
        "ref": "598d9a4747217f28ba69e0f3",
        "required": true
      },
      "name": {
        "name": "name",
        "type": "string"
      },
      "description": {
        "type": "string",
        "name": "description"
      }
    },
    "rules": {
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      },
      "public": {
        "access": []
      }
    },
    "triggers": ""
  }
}
{
  "_id": {
    "$oid": "587641b195ed3c0c59b14602"
  },
  "name": "users",
  "type": "Table",
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": [
      {
        "entity": "59de0170f6d6b47705fb9d43",
        "pre": true,
        "type": "create",
        "name": ""
      }
    ],
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "filter": {
          "user_id": "{$user.id}"
        },
        "access": [
          "list",
          "view"
        ]
      }
    },
    "fields": {
      "phone": {
        "type": "string",
        "name": "phone"
      },
      "name": {
        "type": "string",
        "name": "name"
      },
      "city": {
        "type": "string",
        "name": "city"
      },
      "email": {
        "type": "string",
        "name": "email"
      },
      "sex": {
        "type": "string",
        "name": "sex"
      },
      "birthdate": {
        "type": "date",
        "name": "birthdate"
      },
      "user_id": {
        "required": true,
        "type": "string",
        "name": "user_id"
      },
      "is_social": {
        "type": "boolean",
        "name": "is_social"
      },
      "status": {
        "required": true,
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      },
      "fake_id": {
        "type": "number",
        "name": "fake_id"
      },
      "push_tokens": {
        "type": "object",
        "name": "push_tokens",
        "default": {
          "ios": [],
          "android": []
        }
      }
    },
    "adapter": "MongoDB",
    "indexes": ""
  },
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59145eba2aac0e07c131c5d4"
  },
  "name": "limits",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "contragent": {
        "access": [
          "list",
          "view"
        ],
        "filter": {
          "user_id": "{$user.id}"
        }
      },
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "list",
          "view"
        ]
      }
    },
    "fields": {
      "limit": {
        "required": true,
        "type": "number",
        "name": "limit"
      },
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "duration": {
        "type": "number",
        "name": "duration"
      },
      "product_id": {
        "type": "string",
        "name": "product_id"
      },
      "duration_date": {
        "type": "date",
        "name": "duration_date"
      },
      "reserved_by": {
        "array": true,
        "type": "object",
        "name": "reserved_by"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "595e5f503530f23550bb5c0c"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "try {\n  const contragentRole = '58860d1bc6887053b5978bb3';\n  const activeStatus = '598d9bac47217f28ba69e0f5';\n  if (!data.product_id) throw new Error(404, 'Store not found');\n  let productsTable = yield Table.fetch('products', req.application.id)\n  let product = yield productsTable.findAll({id: data.product_id});\n\n  if (!product.data || !product.data.length) throw new Error(404, 'Product not found!');\n\n  product = product.data[0];\n\n  if (!product.contragent \u0026\u0026 !product.contragent.length) throw new Error(404, 'Contragent not found!');\n\n  let contragentIds = product.user_id;\n  let storesTable = yield Table.fetch('stores', req.application.id);\n  let stores;\n  if (req.user \u0026\u0026 req.user.role.id == contragentRole) {\n      stores = yield storesTable.findAll({user_id: req.user.id, status: activeStatus});\n  } else {\n      stores = yield storesTable.findAll({user_id: {$in: contragentIds}, status: activeStatus});\n  }\n\n  if (!stores.data || !stores.data.length) throw new Error(404, 'Store not found2!');\n  \n  stores = stores.data;\n  \n  return done(stores);\n} catch(error) {\n  done(new Error(error.stack));\n}"
  },
  "name": "get_contragent_stores",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59771d2f29e7625456d78ca1"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nlet getMyGponsScript = yield Script.fetch('get_my_certificates', req.application.id);\ngetMyGponsScript.req = req;\ngetMyGponsScript.data = data;\nlet gpons = yield getMyGponsScript.run();\nlet result = [];\nlet isExist = false;\ngpons.map(cert =\u003e {\n  if (cert.status.id == activeStatus) {\n      result.map(res =\u003e {\n      if (res.product === cert.product) {\n        res.count = res.count + 1;\n        isExist = true;\n        let crt = Object.assign({}, cert);\n        delete crt.product;\n    res.certificates.push(crt);\n      }\n    });\n    if (!isExist) {\n      let crt = Object.assign({}, cert);\n      delete crt.product;\n      result.push({product: cert.product, count: 1, certificates: [crt]});\n    }\n   isExist = false;\n }\n});\nreturn done(result);\n"
  },
  "name": "gift_stat",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "597ae83a29e7625456d794dd"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\nНУЖЕН РЕФАКТОРИНГ\n\nЕсли запуск скрипта идет от админа то нужно отправить доп.параметр\n@param user_id - user_id контрагента\n\n@param data.email - новый логин/почта контрагента\n@param data.name - новое имя контрагента\n  @param - (not required) subcontragentUsername - логин представителя контрагента\n  @param - (not required) subcontragentPassword - пароль представителя контрагента \n@throws - 400, Password field is empty\n@throws - 404, User not found\n*/\nlet caRole = \"58860d1bc6887053b5978bb3\";\nlet adminRole = \"58808abccf1f550f22a8c02a\"\nlet userSys;\nif(req.user.role.id == caRole) {\n  userSys = yield User.find({id: req.user.id, role: caRole}, {}, req.application.id);\n}\nif(req.user.role.id == adminRole) {\n  userSys = yield User.find({id: data.user_id, role: caRole}, {}, req.application.id);\n}\n\nif ( data.subcontragentUsername \u0026\u0026 data.username \u0026\u0026\n data.username.toLowerCase() == data.subcontragentUsername.toLowerCase()) throw new Error(400, 'Same contragent and subcontragent login!');\n\n\n\n\nif (data.email || data.name) {\n  let checkUniqueCa = yield Script.fetch('check_unique_params', req.application.id);\n  checkUniqueCa.data = {username: data.email, name: data.name, role: 'contragents'};\n  checkUniqueCa.req = req;\n  let script = yield checkUniqueCa.run();\n  if (script instanceof Error) throw new Error(400, 'Checking contragent unique error!');\n}\n\nif (data.subcontragentUsername) {\n  let script = yield Script.fetch('check_unique_params', req.application.id);\n  script.data = {\n  username: data.subcontragentUsername,\n  role: 'subcontragents'\n  };\n  script.req = req;\n  yield script.run()\n    .then(result =\u003e {\n     if (result instanceof Error) throw new Error(400, 'Checking subcontragent unique error!');\n    });\n}\n\n\nlet updateData = {};\nif (userSys) {\n  let contragentEmail = userSys.username;\n  let contragentsTable = yield Table.fetch('contragents', req.application.id);\n  let user = yield contragentsTable.find({user_id: userSys.id}).catch(e =\u003e (console.error(e), { data: null }));\n\n  Object.keys(data).map(function (key, index) {\n      Object.assign(updateData,{ [key]: data[key] });\n      if (key == 'email') {\n\n        // вставить валидацию\n\n        contragentEmail = data[key];\n        userSys.username = data[key];\n      }\n  });\n  user.data = yield user.data.update(updateData);\n  yield userSys.save();\n\n// возможность создать представителя\n\nlet sca;\nlet subcontragentEmail;\nconst subcontragentsTable = yield Table.fetch('subcontragents', req.application.id);\nlet subcontragent = yield subcontragentsTable.find({contragent_id: userSys.id}).catch(e =\u003e (console.error(e), {data: null}));\n\nif (subcontragent.data) {\n    let subUserSys = yield User.find({ id: subcontragent.data.user_id }, {}, req.application.id);\n    subcontragentEmail = subUserSys.username;\n\n\n    if (data.subcontragentUsername || data.subcontragentPassword) {\n        const editScaScript = yield Script.fetch('edit_sca', req.application.id);\n        editScaScript.req = req;\n        editScaScript.data = { contragent_id: userSys.id };\n        if (data.subcontragentUsername) {\n            subcontragentEmail = data.subcontragentUsername;\n            Object.assign(editScaScript.data, { username: data.subcontragentUsername });\n        }\n        if (data.subcontragentPassword) {\n            Object.assign(editScaScript.data, { password: data.subcontragentPassword });\n        }\n        sca = yield editScaScript.run();\n        if (data.subcontragentPassword) {\n            // для контрагента\n            let notify = yield Service.fetch('notify', req.application.id);\n            let message = 'У вашего представителя новый пароль в системе: ' + data.subcontragentPassword;\n            let subject = 'Новый пароль у вашего представителя';\n            notify.data = { subject, email: [{ email: contragentEmail }], message };\n            yield notify.request('subcontragent_psw', req);\n            // для представителя\n            message = 'У вас новый пароль в системе: ' + data.subcontragentPassword;\n            subject = 'Новый пароль';\n            notify.data = { subject, email: [{ email: subcontragentEmail }], message };\n            yield notify.request('subcontragent_psw', req);\n        }\n    }\n\n} else {\n    const createNewScaScript = yield Script.fetch('create_new_sca', req.application.id);\n    createNewScaScript.data = { username: data.subcontragentUsername, password: data.subcontragentPassword, contragent_id: userSys.id };\n    createNewScaScript.req = req;\n    sca = yield createNewScaScript.run();\n    if (sca instanceof Error) throw new Error(400, 'Cant create subcontragent!');\n    // для контрагента\n    let message = 'У вашего представителя новый пароль в системе: ' + subcontragentPassword;\n    let subject = 'Новый пароль у вашего представителя';\n    notify.data = { subject, email: [{ email: data.username }], message };\n    yield notify.request('subcontragent_psw', req);\n    // для представителя\n    message = 'У вас новый пароль в системе: ' + subcontragentPassword;\n    subject = 'Новый пароль';\n    notify.data = { subject, email: [{ email: data.subcontragentUsername }], message };\n    yield notify.request('subcontragent_psw', req);\n}\n\n\n\n\n\n  return done({data: {contragent: user.data, subcontragent: sca.data}});\n\n} else {\n  throw new Error(404, 'User not found');\n}\n"
  },
  "name": "edit_ca",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "599193cf1a914d7dc7e6f2c4"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "if (data.name) {\n  let categoryTable = yield Table.fetch('product_categories', req.application.id);\n  let category = yield categoryTable.find({name: data.name}).catch(e =\u003e (console.error(e), { data: null }));\n  if(!category.data) {\n    return done({isUnique: true});\n  }\n} \nreturn done({isUnique: false});\n"
  },
  "name": "is_unique_category_name",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59b7c33d8e8c9a021d48d526"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт сохранения сертификата в истории отправленных\n *\n * @param {string} certificate_id - id сертификата\n */\n\nif (!data.certificate_id) {\n  return done({\n    statusCode: 400,\n    message: 'Certificate id required'\n  });\n}\n\nconst certGivingTable = yield Table.fetch('certificate_giving_history', req.application.id);\nconst sentGpon = yield certGivingTable.find({\n  giver_id: req.user.id,\n  certificate: data.certificate_id\n}).catch(error =\u003e (console.error(error), { data: null }));\n\nif (sentGpon.data) { return done({}); }\n\nlet sentCertificate = yield certGivingTable.create({\n  giver_id: req.user.id,\n  certificate: data.certificate_id,\n  status_updated_at: Date.now()\n});\n\nconsole.log('Sent certificate:\\n', sentCertificate);\n\nreturn done(sentCertificate);\n"
  },
  "name": "set_send_certificates",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59bf84c66c6f2e0226e0fff5"
  },
  "name": "limits_history",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "product_id": {
        "ref": "58973d924802c138d75d91e6",
        "populate": false,
        "type": "referer",
        "name": "product_id"
      },
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "limit": {
        "type": "number",
        "name": "limit"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "59c3667e51ddea023696f8cf"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const tryingCashingHistoryTable = yield Table.fetch('trying_cashing_history', req.application.id);\n  const adminRole = '58808abccf1f550f22a8c02a';\n\n\nconst cashCertificateScript = yield Script.fetch('cash_certificate', req.application.id);\ncashCertificateScript.data = {certificate_id: data.certificate_id, pin: data.pin, store_id: data.store_id};\ncashCertificateScript.req = req;\nlet result = yield cashCertificateScript.run();\nif (result instanceof Error \u0026\u0026 req.user.role.id != adminRole) {\n\n  let obj = {\n    user_id: req.user.id,\n    certificate_id: data.certificate_id,\n    attempts: 1\n  }\n  tryingCashingHistoryTable.req = req;\n  let tryCash = yield tryingCashingHistoryTable.find({user_id: req.user.id, certificate_id: data.certificate_id}).catch(e =\u003e (console.error(e), { data: null }));\n  if (!tryCash.data) {\n    yield tryingCashingHistoryTable.create(obj);\n  } else {\n    // тут проверить если нашли и дата последнего обновления менее N часов назад то обнулять счетчик\n    yield tryCash.data.update({attempts: tryCash.data.attempts + 1});\n  }\n  \n  \n  throw new Error(400, 'Cashing Gpon Error');\n} else {\n  return done(result);\n}"
  },
  "name": "cash_certificate_wrap",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59c8bbe9b85259070a7ebff7"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/// метод для внешних разработчиков\n\nconst subcontragentRole = '5988108288955d4a0dc7d644';\n\nif (!data.username || !data.password) throw new Error(400, 'Username or password is empty');\n\nlet userSys = yield User.find({username: data.username, role: subcontragentRole }, {}, req.application.id);\nif (!userSys) throw new Error(404, 'User not found');\n\nlet subcontragentTable = yield Table.fetch('subcontragents', req.application.id);\n\nlet subcontragent = yield subcontragentTable.find({user_id: userSys.id}).catch(e =\u003e (console.error(e), { data: null }));\n\nlet result;\n if (!subcontragent.data) {\n \u0009result = {id: userSys.id};\n } else {\n  result = subcontragent.data;\n }\n\nreq.body = {username: data.username, password: data.password};\n\nvar options = {\n oauth: {\n accessTokenLifetime: 60 * 60 * 24,\n refreshTokenLifetime: 60 * 60 * 24 * 7\n }\n};\n\nlet token = yield Auth.login.oauth(req, options).catch(err =\u003e done(err));\nreturn done({data: result, token:token, role: subcontragentRole});\n"
  },
  "name": "login_subcontragent",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59ca0e161a85d26becf7efe2"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const appId = '587640c995ed3c0c59b14600'\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nconst spentStatus = '598d9bb147217f28ba69e0fc';\nconst overdueStatus = '598d9bba47217f28ba69e0fd';\nconst deletedStatus = '598d9ff947217f28ba69e10a';\n\nlet certificates = [];\nconst table = yield Table.fetch('certificates', appId);\ncertificates = yield table.findAll({status: activeStatus});\n\nif (!certificates.data) { return done(); }\n\nyield certificates.data.map(function *(certificate) {\n  if (!certificate.status) { return; }\n\n  const now = Date.now();\n  if (certificate.end_sale_date \u003c now) {\n    yield certificate.update({status: overdueStatus, deactivation_date: now});\n    return;\n  }\n});\n\nconst incativeStatuses = [spentStatus, overdueStatus];\ncertificates = yield table.findAll({status: {$in: incativeStatuses}});\n\nyield certificates.data.map(function *(certificate) {\n  const removalPeriod = 1000 * 60 * 60 * 24 * 30;\n\n  if (certificate.deactivation_date \u0026\u0026\n      (Date.now() - certificate.deactivation_date) \u003e removalPeriod) {\n    yield certificate.update({status: deletedStatus});\n  }\n});\n\nreturn done();"
  },
  "name": "update_certificate_status",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59ca76ca473d99711af24e66"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Скрипт создания представителя контрагента\n *\n * @param {string} username - логин пользователя в системе\n * @param {string} contragent_id - id контрагента (системного пользователя) которого он представляет в системе\n */\n// \u0009contragent_id - системный id контрагента\u0009email- логин представителя\u0009user_id - его id системный\nif (!data.username || !data.contragent_id || !data.password) {\n  throw new Error(400, 'Enter correct data!');\n}\n\ndata.username = data.username.toLowerCase();\nlet scaRole = '5988108288955d4a0dc7d644';\n\nlet password = data.password;\n\nlet userSys = new User({username: data.username, role: scaRole, type: \"oauth\"},\n                       req.application.id);\nuserSys.password = password;\nyield userSys.save();\n\ndelete data.username;\n\nlet newSubContragent = {user_id: userSys.id, email: userSys.username, contragent_id: data.contragent_id};\n\nlet usersTable = yield Table.fetch('subcontragents', req.application.id);\nlet user = yield usersTable.create(newSubContragent);\n\nreturn done({data: user});\n"
  },
  "name": "create_new_sca",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59d0f66d3db85407254a0cef"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const adminRole = '58808abccf1f550f22a8c02a';\nif (req.user.role.id != adminRole) throw new Error(400, 'Bad request');\nif (!data.userId) throw new Error(400, 'Bad request');\nconst banRole = '59c34d2851ddea023696f860';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nconst deleteStatus = '598d9ff947217f28ba69e10a';\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst contragentsTable = yield Table.fetch('contragents', req.application.id);\nconst productsTable = yield Table.fetch('products', req.application.id);\nconst softDeleteProductScript = yield Script.fetch('soft_delete_products', req.application.id);\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\n\n\nlet userSys = yield User.find({id: data.userId, role: contragentRole}, {}, req.application.id);\nif (!userSys) throw new Error(404, 'User not found');\nlet contragent = yield contragentsTable.find({user_id: data.userId}).catch(e =\u003e (console.error(e), { data: null }));\n\nlet products = yield productsTable.findAll({user_id: data.userId, status: activeStatus});\n\n\n// ищем активные джипоны на товары\nif(products.data) {\n  yield products.data.map(function* (product) {\n    let activeGpon = yield certificatesTable.find({user_id: data.userId, status: activeStatus}).catch(e =\u003e (console.error(e), { data: null }));\n    if (activeGpon.data) throw new Error(404, 'Contragent has active gpon');\n  });\n\n  yield products.data.map(function* (product) {\n    if (product.user_id.length == 1) {\n      softDeleteProductScript.data = {productId: product.id};\n      softDeleteProductScript.req = req;\n      let data = yield softDeleteProductScript.run();\n    }\n  });\n}\n\nuserSys.role = banRole;\nyield userSys.save();\nlet result = yield contragent.data.update({status: deleteStatus});\n\n return done(result);\n"
  },
  "name": "soft_delete_ca",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5876419795ed3c0c59b14601"
  },
  "name": "contragents",
  "type": "Table",
  "options": {
    "triggers": [
      {
        "entity": "59de0170f6d6b47705fb9d43",
        "pre": true,
        "type": "create",
        "name": ""
      }
    ],
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "name": {
        "type": "string",
        "name": "name"
      },
      "logo": {
        "ref": "58b91e756521367de466f328",
        "populate": {
          "filter": "",
          "select": [
            "image"
          ]
        },
        "type": "referer",
        "name": "logo"
      },
      "description": {
        "type": "string",
        "name": "description"
      },
      "phone": {
        "type": "string",
        "name": "phone"
      },
      "city": {
        "type": "string",
        "name": "city"
      },
      "fact_city": {
        "type": "string",
        "name": "fact_city"
      },
      "law_city": {
        "type": "string",
        "name": "law_city"
      },
      "user_id": {
        "required": true,
        "type": "string",
        "name": "user_id"
      },
      "delivery_email": {
        "type": "string",
        "name": "delivery_email"
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "required": true,
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      },
      "law_street": {
        "type": "string",
        "name": "law_street"
      },
      "fact_street": {
        "type": "string",
        "name": "fact_street"
      },
      "law_building": {
        "type": "string",
        "name": "law_building"
      },
      "fact_building": {
        "type": "string",
        "name": "fact_building"
      },
      "commission_common": {
        "required": true,
        "type": "number",
        "name": "commission_common"
      },
      "agent_contract_number": {
        "type": "string",
        "name": "agent_contract_number"
      },
      "agent_contract_date": {
        "type": "date",
        "name": "agent_contract_date"
      },
      "inn": {
        "type": "string",
        "name": "inn"
      },
      "legal_type": {
        "type": "string",
        "name": "legal_type"
      },
      "contract_type": {
        "type": "string",
        "name": "contract_type"
      },
      "recon_company": {
        "type": "string",
        "name": "recon_company"
      },
      "recon_person_view": {
        "type": "string",
        "name": "recon_person_view"
      },
      "recon_email": {
        "type": "string",
        "name": "recon_email"
      },
      "recon_day": {
        "type": "number",
        "name": "recon_day"
      },
      "recon_person": {
        "type": "string",
        "name": "recon_person"
      },
      "recon_person_authority": {
        "type": "string",
        "name": "recon_person_authority"
      }
    },
    "adapter": "MongoDB"
  },
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59d0f6c43db85407254a0cf3"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const adminRole = '58808abccf1f550f22a8c02a';\nif (!data.userId \u0026\u0026 req.user.role.id == adminRole) throw new Error(400, 'Bad request');\nconst banRole = '59c34d2851ddea023696f860';\nconst deleteStatus = '598d9ff947217f28ba69e10a';\nconst usersTable = yield Table.fetch('users', req.application.id);\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nconst gponActiveStatus = '598d9bac47217f28ba69e0f5';\nconst mobileUserRole = '58b40f669154c320f9831bfa';\n\nlet userSys = yield User.find({id: data.userId, role: mobileUserRole}, {}, req.application.id);\nif (!userSys) throw new Error(404, 'SysUser not found');\nlet user = yield usersTable.find({user_id: data.userId}).catch(e =\u003e (console.error(e), { data: null }));\nif (!user.data) throw new Error(404, 'User not found');\n\nlet activeGpon = yield certificatesTable.find({status: gponActiveStatus, buyer_id: data.userId}).catch(e =\u003e (console.error(e), {data: null}));\nif (activeGpon.data) throw new Error(403, 'User has active gpons');\n\nuserSys.role = banRole;\nyield userSys.save();\nlet result = yield user.data.update({status: deleteStatus});\n\nreturn done(result)"
  },
  "name": "soft_delete_user",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59d359a83db85407254a174a"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n@params - product_id\n@params - code\n@params - end_sale_date\n@params - status\n@params - price\n-----------------------\n@param - limit\n@param - page\n\n*/\n\nconst adminRole = '58808abccf1f550f22a8c02a';\nconst contragentRole = '58860d1bc6887053b5978bb3';\nif (!data.product_id \u0026\u0026 (req.user.role.id == adminRole || req.user.role.id == contragentRole)) throw new Error(400, 'Bad request');\n\n\nlet params = {\n\u0009product: data.product_id,\n};\n\nif (data.code) params.code =  { $regex: data.code, $options: 'i' };\nif (data.end_sale_date) params.end_sale_date = { $lt: data.end_sale_date};\nif (data.status) params.status = { $in: data.status };\n\n\nlet options = {};\nif (data.limit) options.limit = data.limit;\nif (data.page) options.skip = data.page * data.limit || 0;\n\nif (data.sort) options.sort = data.sort;\n\n\n\n//let result = [];\n\nconst paytureOrdersTable = yield Table.fetch('payture_orders', req.application.id);\nconst usersTable = yield Table.fetch('users', req.application.id);\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\nif (req.user.role.id == contragentRole) Object.assign(params, {status: {$ne: activeStatus}, user_id: req.user.id});\n\n\nlet certificates = yield certificatesTable.findAll(params, options);\nif (!certificates.data.length) return done({data: []});\n\n// выборка для админа с именем пользователя и телефоном\nif (req.user.role.id == adminRole) {\n yield certificates.data.map(function* (certificate) {\n \u0009delete certificate.pin;\n\n   // добавить имя покупателя и телефон\n\u0009\u0009let buyer = yield usersTable.find({user_id: certificate.buyer_id}).catch(e =\u003e (console.error(e), { data: null }));\n\u0009\u0009delete certificate.buyer_id;\n\u0009\u0009Object.assign(certificate, {buyer: {phone: buyer.data.phone, name: buyer.data.name, user_id: buyer.data.user_id}});\n\n\u0009\u0009// добавление цены по которой был продан\n\u0009\u0009let order = yield paytureOrdersTable.find({order_id: certificate.order_id}).catch(e =\u003e (console.error(e), { data: null }));\n\n\u0009\u0009if (data.price || data.price === 0) {\n\u0009\u0009\u0009if (data.price == order.data.amount/100) {\n              \n\u0009\u0009\u0009\u0009Object.assign(certificate, {price: order.data.amount/100});\n\u0009\u0009\u0009} \n\u0009\u0009} else {\n\u0009\u0009\u0009Object.assign(certificate, {price: order.data.amount/100});\n\u0009\u0009}\n\n\u0009});\n\n}\n\nif (req.user.role.id == contragentRole) {\n  yield certificates.data.map(function* (certificate) {\n\u0009delete certificate.pin;\n\u0009\n\u0009\u0009// добавление и фильтр цене по которой был продан\n\u0009\u0009let order = yield paytureOrdersTable.find({order_id: certificate.order_id}).catch(e =\u003e (console.error(e), { data: null }));\n\n\u0009\u0009if (data.price || data.price === 0) {\n\u0009\u0009\u0009if (data.price == order.data.amount/100) {\n\u0009\u0009\u0009\u0009Object.assign(certificate, {price: order.data.amount/100});\n\u0009\u0009\u0009}\n\u0009\u0009} else {\n\u0009\u0009\u0009Object.assign(certificate, {price: order.data.amount/100});\n\u0009\u0009}\n\n\u0009});\n\n}\n\nreturn done(certificates.data);\n"
  },
  "name": "get_gpons_by_product",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59de0170f6d6b47705fb9d43"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "if (data.type == 'create') {\n  const activeStatus = '598d9bac47217f28ba69e0f5';\n\n  let updateData = {status: activeStatus};\n\n  data.newData = Object.assign(data.newData, updateData);\n}\n  return done();"
  },
  "name": "active_status_trigger",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e0b1a65c23ce0946a0be87"
  },
  "name": "encoded_url_pairs",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "public": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      },
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      }
    },
    "fields": {
      "origin": {
        "type": "string",
        "name": "origin"
      },
      "encoded": {
        "type": "string",
        "name": "encoded"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5a0d6e99efe6fd072f3a2923"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const contragentRoleId = '58860d1bc6887053b5978bb3';\nlet caRole = yield Role.find({id: contragentRoleId}, {}, req.application.id);\nlet result = {};\n  if (data.create_product == true \u0026\u0026 caRole.permissions.create_product.all.length == 0) {\n    caRole.permissions.create_product.all.push(\"run\");\n    Object.assign(result, {create_product: true});\n  } \n  if (data.create_product == false \u0026\u0026 caRole.permissions.create_product.all.length == 1) {\n    caRole.permissions.create_product.all.splice(0,1);\n    Object.assign(result, {create_product: false});\n  } \n\n\n  if (data.edit_product == true \u0026\u0026 caRole.permissions.edit_product.all.length == 0) {\n    caRole.permissions.edit_product.all.push(\"run\");\n    Object.assign(result, {edit_product: true});\n  }\n  if (data.edit_product == false \u0026\u0026 caRole.permissions.edit_product.all.length == 1) {\n    caRole.permissions.edit_product.all.splice(0,1);\n    Object.assign(result, {edit_product: false});\n  }\n\n\n  if (data.delete_product == true \u0026\u0026 caRole.permissions.soft_delete_products.all.length == 0) {\n    caRole.permissions.soft_delete_products.all.push(\"run\");\n     Object.assign(result, {delete_product: true});\n  }\n  if (data.delete_product == false \u0026\u0026 caRole.permissions.soft_delete_products.all.length == 1) {\n    caRole.permissions.soft_delete_products.all.splice(0,1);\n    Object.assign(result, {delete_product: false});\n  }\n\n yield caRole.save();\nreturn done(result);"
  },
  "name": "contragent_rules_product_edit",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "587641dd95ed3c0c59b14604"
  },
  "name": "product_categories",
  "type": "Table",
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": [
      {
        "entity": "59de0170f6d6b47705fb9d43",
        "post": false,
        "pre": true,
        "type": "create",
        "name": ""
      }
    ],
    "rules": {
      "contragent": {
        "filter": {
          "status": "598d9bac47217f28ba69e0f5",
          "_id": {
            "_DS_ne": "58e5f191d351f81cc3fa6a0a"
          }
        },
        "access": [
          "list",
          "view"
        ]
      },
      "public": {
        "access": []
      },
      "all": {
        "filter": {
          "status": "598d9bac47217f28ba69e0f5"
        },
        "access": [
          "list",
          "view"
        ]
      }
    },
    "fields": {
      "name": {
        "required": true,
        "type": "string",
        "name": "name"
      },
      "icon": {
        "populate": {
          "filter": "",
          "select": [
            "image"
          ]
        },
        "ref": "58b91e756521367de466f328",
        "type": "referer",
        "name": "icon"
      },
      "status": {
        "required": true,
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      },
      "is_adult": {
        "required": true,
        "type": "boolean",
        "name": "is_adult"
      },
      "fake_id": {
        "type": "number",
        "name": "fake_id"
      }
    },
    "adapter": "MongoDB",
    "indexes": ""
  },
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "58973d924802c138d75d91e6"
  },
  "name": "products",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": [
      {
        "entity": "5a212d966dc4227345998731",
        "post": false,
        "pre": true,
        "type": "update",
        "name": ""
      },
      {
        "entity": "5a0aad8cec69d90742bae4d7",
        "pre": true,
        "type": "create",
        "name": ""
      },
      {
        "entity": "59de0170f6d6b47705fb9d43",
        "pre": true,
        "type": "create",
        "name": ""
      }
    ],
    "params": {
      "timestamps": true
    },
    "rules": {
      "contragent": {
        "filter": {
          "user_id": "{$user.id}"
        },
        "access": [
          "list",
          "view"
        ]
      },
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "list",
          "view"
        ]
      }
    },
    "fields": {
      "product_photo": {
        "ref": "58b91e756521367de466f328",
        "populate": {
          "filter": "",
          "select": [
            "image"
          ]
        },
        "type": "referer",
        "name": "product_photo"
      },
      "output_price": {
        "required": true,
        "type": "number",
        "name": "output_price"
      },
      "description": {
        "type": "string",
        "name": "description"
      },
      "icon": {
        "populate": {
          "filter": "",
          "select": [
            "image"
          ]
        },
        "ref": "58b91e756521367de466f328",
        "type": "referer",
        "name": "icon"
      },
      "contragent": {
        "array": true,
        "required": true,
        "populate": true,
        "ref": "5876419795ed3c0c59b14601",
        "type": "referer",
        "name": "contragent"
      },
      "name": {
        "required": true,
        "type": "string",
        "name": "name"
      },
      "categories": {
        "required": true,
        "populate": false,
        "ref": "587641dd95ed3c0c59b14604",
        "array": true,
        "type": "referer",
        "name": "categories"
      },
      "code_type": {
        "type": "string",
        "name": "code_type"
      },
      "is_delivery": {
        "required": true,
        "type": "boolean",
        "name": "is_delivery"
      },
      "user_id": {
        "array": true,
        "required": true,
        "type": "string",
        "name": "user_id"
      },
      "status": {
        "required": true,
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      },
      "delivery_phone": {
        "type": "string",
        "name": "delivery_phone"
      },
      "delivery_type": {
        "type": "boolean",
        "name": "delivery_type"
      },
      "is_adult": {
        "required": true,
        "type": "boolean",
        "name": "is_adult"
      },
      "is_coupon_limited": {
        "type": "boolean",
        "name": "is_coupon_limited"
      },
      "fake_id": {
        "type": "object",
        "name": "fake_id"
      },
      "instruction": {
        "ref": "5ae3316ae0e6b91fe110689c",
        "populate": false,
        "type": "referer",
        "name": "instruction"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5a13bdc89f272c123aacefcd"
  },
  "name": "coupons",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      },
      "code": {
        "type": "string",
        "name": "code"
      },
      "product": {
        "ref": "58973d924802c138d75d91e6",
        "populate": false,
        "type": "referer",
        "name": "product"
      },
      "guid": {
        "ref": "5a144f109f272c123aacf332",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "guid"
      },
      "reserved_by": {
        "array": false,
        "type": "string",
        "name": "reserved_by"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "58b5944b91a2f13f65144a53"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "let mobileUserRole = \"58b40f669154c320f9831bfa\";\n\nif (!data.username || !data.password) throw new Error(400, 'Empty username or password');\n\nlet userSys = yield User.find({username: data.username, role: mobileUserRole}, {}, req.application.id);\nif (!userSys) throw new Error(404, 'User not found');\n\nlet usersTable = yield Table.fetch('users', req.application.id);\n\nlet user = yield usersTable.find({user_id: userSys.id}).catch(e =\u003e (console.error(e), { data: null }));\nif(!user.data) throw new Error(404, 'User not found');\nlet result = user.data;\n\nreq.body = {username: data.username, password: data.password};\nvar options = {\n oauth: {\n accessTokenLifetime: 60 * 60 * 24,\n refreshTokenLifetime: 60 * 60 * 24 * 7\n }\n};\n\nlet token = yield Auth.login.oauth(req, options).catch(err =\u003e (console.error(err), null));\nif (!token) throw new Error(404, 'Wrong password');\nreturn done({data: result, token:token});"
  },
  "name": "login_mobile",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "58b5941f91a2f13f65144a51"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const mobileUserRole = \"58b40f669154c320f9831bfa\";\nconst adminRole = \"58808abccf1f550f22a8c02a\";\nconst superadminRole = \"589732e094431f63462f88b0\";\nconst subcontragentRole = '5988108288955d4a0dc7d644';\n\nif (!data.username || !data.password) throw new Error(400, 'Username or password is empty');\n\nlet userSys = yield User.find({username: data.username, role: { $ne: mobileUserRole } }, {}, req.application.id);\nif (!userSys) throw new Error(404, 'User not found');\n\nlet contragents = yield Table.fetch('contragents', req.application.id);\n\nlet contragent = yield contragents.find({user_id: userSys.id}).catch(e =\u003e (console.error(e), { data: null }));\n\nlet result;\nlet rules;\n\nif (userSys.role == subcontragentRole) {\n\u0009const loginScript = yield Script.fetch('login_subcontragent', req.application.id);\n\u0009loginScript.req = req;\n\u0009loginScript.data = {username: data.username, password: data.password};\n\u0009let result = yield loginScript.run();\n\u0009return done(result);\n}\n\n if (!contragent.data \u0026\u0026 (userSys.role == adminRole || userSys.role == superadminRole)) {\n \u0009result = {id: userSys.id};\n } else {\n result = contragent.data;\n const getCaProductRulesScript = yield Script.fetch('get_contragent_product_rules', req.application.id);\n getCaProductRulesScript.req = req;\n getCaProductRulesScript.data = {};\n rules = yield getCaProductRulesScript.run();\n }\n\nreq.body = {username: data.username, password: data.password};\n\nvar options = {\n oauth: {\n accessTokenLifetime: 60 * 60 * 24,\n refreshTokenLifetime: 60 * 60 * 24 * 7\n }\n};\n\nlet token = yield Auth.login.oauth(req, options).catch(err =\u003e done(err));\n\nreturn done({data: result, role: userSys.role, token:token, rules});"
  },
  "name": "login",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a14228e9f272c123aacf138"
  },
  "name": "csv-parser",
  "type": "Service",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "importScript": "csv_parse_finish"
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "send"
        ]
      }
    },
    "routes": {
      "parse": {
        "params": {
          "request": "{$this.data}"
        },
        "method": "POST",
        "route": "parse",
        "name": "parse"
      }
    },
    "port": "4320",
    "host": "localhost"
  }
}
{
  "_id": {
    "$oid": "58b5943791a2f13f65144a52"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "let mobileRole = '58b40f669154c320f9831bfa';\nif (!data.token) throw new Error(400, 'Error');\nlet token;\nreq.body = {token: data.token};\nvar options = {\n vk: {\n client_id: \"6189863\",\n client_secret: \"JfGBaCXC4dTVNxAdZ2Mb\"\n },\n oauth: {\n accessTokenLifetime: 60 * 60 * 24,\n refreshTokenLifetime: 60 * 60 * 24 * 7\n },\n facebook: true,\n ok: {\n application_key: \"CBAIIKNLEBABABABA\",\n application_secret_key: \"9700C428A56864D80EC6DE78\"\n }\n};\n\nlet errors = []\ntoken = yield Auth.login.vk(req, options, mobileRole).catch(err =\u003e (errors.push(err), null));\nif(!token) token = yield Auth.login.ok(req, options, mobileRole).catch(err =\u003e (errors.push(err), null));\nif(!token) token = yield Auth.login.facebook(req, options, mobileRole).catch(err =\u003e (errors.push(err), null));\n\nif (!token) {\n  throw new Error(401, 'Cant authorized');\n}\n\nlet Users = yield Table.fetch('users', req.application.id);\n\nlet user = yield Users.findAll({user_id: token.user_id});\nlet result;\nif (!user.data.length) {\n  if(data.userInfo) {\n  result = yield Users.create({user_id: token.user_id, phone: data.userInfo.phone,\n    city: data.userInfo.city, sex: data.userInfo.sex, email: data.userInfo.email, name: data.userInfo.name,\n     birthdate: data.userInfo.birthdate || new Date().getTime(), is_social: true});\n  } else {\n    result = yield Users.create({user_id: token.user_id});\n  }\n} else {\n  result = user.data[0];\n}\nObject.assign(result, {is_social: true});\nreturn done({data: result, token:token});\n"
  },
  "name": "login_mobile_social",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a1433bb9f272c123aacf316"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const activeStatus = '598d9bac47217f28ba69e0f5';\n\n\nif (!data.productId) throw new Error(400, 'Bad request!');\nconst productTable = yield Table.fetch('products', req.application.id);\nlet product = yield productTable.find({id: data.productId, status: activeStatus}).catch(e =\u003e (console.log(e), {data: null}));\nif (!product.data) throw new Error(404, 'Product not found!');\n\nconst limitsTable = yield Table.fetch('limits', req.application.id);\nlet limit = yield limitsTable.find({product_id: data.productId}).catch(e =\u003e (console.log(e), {data: null}));\nif (!limit.data) throw new Error(404, 'Limit not found!');\nObject.assign(product.data, {product_limit: limit.data.limit});\nreturn done(product.data);"
  },
  "name": "get_product_by_id_with_limits",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a144f109f272c123aacf332"
  },
  "name": "guid",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "guid": {
        "type": "string",
        "name": "guid"
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "58b7c0bb91a2f13f65144b57"
  },
  "name": "verification_codes",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "username": {
        "type": "string",
        "name": "username"
      },
      "code": {
        "type": "string",
        "name": "code"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5a1470129f272c123aacf339"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "if (!data.guid || !data.product_id) throw new Error(400, 'Not enough params!');\n\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\nconst guidTable = yield Table.fetch('guid', req.application.id);\nlet guid = yield guidTable.find({guid: data.guid}).catch(e =\u003e (console.log(e), {data: null}));\nif (!guid.data) throw new Error(404, 'Giud not found!');\n\nconst couponsTable = yield Table.fetch('coupons', req.application.id);\nlet updatedData = yield couponsTable.updateMany({guid: guid.data.id}, {status: activeStatus, product: data.product_id});\n\nlet result = yield guid.data.update({status:activeStatus});\nreturn done(result);"
  },
  "name": "confirm_coupons",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "58b6a69491a2f13f65144aa0"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n * Функция регистрации мобильного пользователя oauth2\n * 1 Запрос на получение кода верификации регистрации\n * @param {string} username - логин пользователя\n *\n * 2 Запрос на сохранение данных юзера при удачной верификации\n * @param {sring} username - логин пользователя\n * @param {number} password - пароль пользователя\n * @param {number} code - код верификации\n * @param {sring} city - город\n * @param {sring} sex - пол\n * @param {date} birthdate - дата рождения\n * @param {sring} name - имя\n * @param {sring} email - email\n*/\n\ndelete data.phone;\n\nfunction inUse() {\n  return done({\n    message: 'Phone already in use',\n    statusCode: 400\n  });    \n};\n\nlet mobileUserRole = \"58b40f669154c320f9831bfa\";\n\nif (data.username \u0026\u0026 !data.code) {\n  let userSys = yield User.find({username: data.username, role: mobileUserRole, type: 'oauth'},\n                                {}, req.application.id);\n  if (userSys) { return inUse(); }\n\n  let usersTable = yield Table.fetch('users', req.application.id);\n  let user = yield usersTable.find({phone: data.username})\n    .catch(e =\u003e (console.error(e), { data: null }));\n\n  if (user.data) { return inUse(); }\n\n\n  let code = Math.round(Math.random() * (9999 - 1298) + 1298);\n  let verificationCodesTable = yield Table.fetch('verification_codes', req.application.id);\n\n  let verificationCode = yield verificationCodesTable.find({username: data.username})\n    .catch(e =\u003e (console.error(e), { data: null }));\n  if (!verificationCode.data) {\n    verificationCode = yield verificationCodesTable.create({username: data.username, code: code});\n  } else {\n    verificationCode = yield verificationCode.data.update({code: code});\n  }\n\n  let notify = yield Service.fetch('notify', req.application.id);\n  notify.data = {to:[{number: data.username}], code: code };\n  yield notify.request('sms_verify', req);\n\n  return done({\n    message: 'SMS has been sent!',\n    statusCode: 200\n  });\n}\n\nif (!data.username || !data.password || !data.code) {\n  return done({\n    message: 'Required fields are empty',\n    statusCode: 400\n  });  \n}\n\nif (data.username \u0026\u0026 data.password \u0026\u0026 data.code) {\n  let verificationCodesTable = yield Table.fetch('verification_codes', req.application.id);\n  let verificationCode = yield verificationCodesTable.find({username: data.username, code: data.code})\n    .catch(e =\u003e (console.error(e), { data: null }));\n\n  if (!verificationCode.data) {\n    return done({\n      message: 'Code not found',\n      statusCode: 404\n    });\n  }\n\n  yield verificationCodesTable.remove({id: verificationCode.data.id});\n  delete data.code;\n\n  let userSys = yield User.find({username: data.username, role: mobileUserRole, type: 'oauth'},\n                                {}, req.application.id);\n  if (userSys) { return inUse(); }\n\n  let usersTable = yield Table.fetch('users', req.application.id);\n  let user = yield usersTable.find({phone: data.username})\n    .catch(e =\u003e (console.error(e), { data: null }));\n\n  if (user.data) {\n    return done({\n      message: 'Phone already in use',\n      statusCode: 400\n    });\n  }\n\n  data.phone = data.username;\n\n\n\n  let row = {\n    is_social: false\n  }\n\n  if (data.email) {\n    function emailInUse() {\n      return done({\n        message: 'Email already in use',\n        statusCode: 400\n      });\n    };\n\n    let userSysEmail = yield User.find({username: data.email, role: mobileUserRole, type: 'oauth'},\n                                       {}, req.application.id)\n      .catch(e =\u003e (console.error(e), {data: null}));\n    if (userSysEmail) { return emailInUse(); }\n\n    let userByEmail = yield usersTable.find({email: data.email})\n      .catch(e =\u003e (console.error(e), {data: null}));\n    if (userByEmail.data) { return emailInUse(); }\n\n    row.email = data.email;\n  }\n\n  if (data.phone) { row.phone = data.phone; }\n  if (data.birthdate) { row.birthdate = data.birthdate; }\n  if (data.sex) { row.sex = data.sex; }\n  if (data.city) { row.city = data.city; }\n  if (data.name) { row.name = data.name; }\n\n\n  let newUserSys = new User({username: data.username, role: mobileUserRole, type: \"oauth\"}, req.application.id);\n  newUserSys.password = data.password;\n\n  yield newUserSys.save();\n  row.user_id = newUserSys.id;\n\n  yield usersTable.create(row);\n\n  return done({\n    message: 'User created successfully',\n    statusCode: 200,\n    data: row\n  });\n}\n"
  },
  "name": "registration_mobile",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a16dacab6b7e15bf964f9f1"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Скрипт подгружающий данные для джипоны\n\u0009Доступен для всех ролей.\n\u0009@param id - id gpon\n*/\n\nconst adminRole = '58808abccf1f550f22a8c02a';\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst mobileRole = '58b40f669154c320f9831bfa';\nconst subcontragentRole = '5988108288955d4a0dc7d644';\n\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\n\n\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nconst options = { select: [\"buy_date\", \"buyer_id\", \"code\", \"end_sale_date\", \"expiration_days\", \"order_id\", \"product\", \"status\", \"status_updated_at\", \"user_id\"]};\n\nif (req.user.role.id == subcontragentRole) {\n\u0009if (!data.id) throw new Error(400, 'No params!');\n\u0009const subcontragentsTable = yield Table.fetch('subcontragents', req.application.id);\n\u0009let subcontragent = yield subcontragentsTable.find({user_id: req.user.id}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009let certificate = yield certificatesTable.find({id: data.id, user_id: subcontragent.data.contragent_id,\n\u0009 status: activeStatus}, options).catch(e =\u003e (console.log(e), {data: null}));\n\u0009if (!certificate.data) throw new Error(404, 'Gpon not found!');\n\u0009return done(certificate.data);\n}\n\nif (req.user.role.id == contragentRole) {\n\u0009if (!data.id) throw new Error(400, 'No params!');\n\u0009const contragentsTable = yield Table.fetch('contragents', req.application.id);\n\u0009let contragent = yield contragentsTable.find({user_id: req.user.id}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009let certificate = yield certificatesTable.find({id: data.id, user_id: contragent.data.user_id}, options).catch(e =\u003e (console.log(e), {data: null}));\n\u0009if (!certificate.data) throw new Error(404, 'Gpon not found!');\n\u0009return done(certificate.data);\n}\n\nif (req.user.role.id == adminRole) {\n\u0009if (!data.id) throw new Error(400, 'No params!');\n\u0009options.select.push('pin');\n\u0009let certificate = yield certificatesTable.find({id: data.id}, options).catch(e =\u003e (console.log(e), {data: null}));\n\u0009if (!certificate.data) throw new Error(404, 'Gpon not found!');\n\u0009return done(certificate.data);\n}\n\nif (req.user.role.id == mobileRole) {\n\u0009if (!data.id \u0026\u0026 !data.order_id) throw new Error(400, 'No params!');\n\u0009options.select.push('pin');\n\u0009let params = {\n\u0009\u0009status: activeStatus\n\u0009};\n\u0009if (data.id) params.id = data.id;\n\u0009if (data.order_id) params.order_id = data.order_id;\n\u0009let certificate = yield certificatesTable.find(params, options).catch(e =\u003e (console.log(e), {data: null}));\n\u0009if (!certificate.data) throw new Error(404, 'Gpon not found!');\n\u0009return done({data: certificate.data});\n}\n"
  },
  "name": "get_gpon",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a19c5d3b6b7e15bf9651214"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Скрипт для админа, ошибка если в топе 20 товаров, если меньше то позволит добавить\n\n*/\n// если товар уже в топе\nconst topCategoryId = '58e5f191d351f81cc3fa6a0a';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nconst productsTable = yield Table.fetch('products', req.application.id);\nlet products = yield productsTable.findAll({categories: topCategoryId, status: activeStatus});\nif (products.count \u003e= 20) throw new Error(400, 'Cant add product!');\nreturn done('OK!');"
  },
  "name": "check_category_top",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "587641c295ed3c0c59b14603"
  },
  "name": "certificates",
  "type": "Table",
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "end_sale_date": {
        "required": true,
        "type": "date",
        "name": "end_sale_date"
      },
      "product": {
        "ref": "58973d924802c138d75d91e6",
        "populate": true,
        "required": true,
        "type": "referer",
        "name": "product"
      },
      "buyer_id": {
        "required": true,
        "ref": "587641b195ed3c0c59b14602",
        "type": "string",
        "name": "buyer_id"
      },
      "buy_date": {
        "required": true,
        "type": "date",
        "name": "buy_date"
      },
      "code": {
        "required": true,
        "type": "string",
        "name": "code"
      },
      "order_id": {
        "required": true,
        "type": "string",
        "name": "order_id"
      },
      "user_id": {
        "array": true,
        "type": "string",
        "name": "user_id"
      },
      "status": {
        "required": true,
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": {
          "filter": "",
          "select": [
            "name_en",
            "name"
          ]
        },
        "type": "referer",
        "name": "status"
      },
      "pin": {
        "required": true,
        "type": "string",
        "name": "pin"
      },
      "expiration_days": {
        "type": "number",
        "name": "expiration_days"
      },
      "status_updated_at": {
        "type": "date",
        "name": "status_updated_at"
      },
      "deactivation_date": {
        "type": "date",
        "name": "deactivation_date"
      },
      "delivery_request_date": {
        "type": "date",
        "name": "delivery_request_date"
      },
      "delivery_request_processed": {
        "type": "boolean",
        "name": "delivery_request_processed"
      },
      "delivery_request": {
        "type": "string",
        "name": "delivery_request"
      }
    },
    "adapter": "MongoDB",
    "indexes": ""
  },
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a3bb9d44e978b1c141ed963"
  },
  "name": "payture_transactions",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": false
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      }
    },
    "fields": {
      "orderId": {
        "type": "string",
        "name": "orderId",
        "required": true
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "required": true,
        "populate": false,
        "type": "string",
        "name": "status"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5a855cee265be107208274df"
  },
  "name": "counters",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "adapter": "MongoDB",
    "fields": {
      "value": {
        "name": "value",
        "type": "object",
        "required": true
      },
      "name": {
        "name": "name",
        "type": "string",
        "required": true
      }
    },
    "rules": {
      "all": {
        "access": []
      },
      "public": {
        "access": []
      }
    },
    "triggers": ""
  }
}
{
  "_id": {
    "$oid": "5a95044e265be107208275c9"
  },
  "name": "rules",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "params": {
      "timestamps": true
    },
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "route": {
        "type": "string",
        "name": "route"
      },
      "role": {
        "array": true,
        "type": "string",
        "name": "role"
      },
      "description": {
        "type": "string",
        "name": "description"
      },
      "is_editable": {
        "type": "boolean",
        "name": "is_editable"
      },
      "is_real": {
        "type": "boolean",
        "name": "is_real"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5a9fefa4265be10720827a26"
  },
  "name": "trying_login_history",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      }
    },
    "fields": {
      "ip": {
        "required": true,
        "type": "string",
        "name": "ip"
      },
      "try_counter": {
        "required": true,
        "type": "number",
        "name": "try_counter"
      },
      "last_try_time": {
        "type": "date",
        "name": "last_try_time",
        "required": true
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5876420595ed3c0c59b14606"
  },
  "name": "stores",
  "type": "Table",
  "options": {
    "triggers": [
      {
        "entity": "59de0170f6d6b47705fb9d43",
        "pre": true,
        "type": "create",
        "name": ""
      }
    ],
    "params": {
      "timestamps": true
    },
    "rules": {
      "contragent": {
        "access": [],
        "filter": {
          "status": "598d9bac47217f28ba69e0f5",
          "user_id": "{$user.id}"
        }
      },
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "list",
          "view"
        ],
        "filter": {
          "status": "598d9bac47217f28ba69e0f5"
        }
      }
    },
    "fields": {
      "email": {
        "type": "string",
        "name": "email"
      },
      "geo": {
        "type": "geo",
        "name": "geo"
      },
      "city": {
        "type": "string",
        "name": "city"
      },
      "name": {
        "type": "string",
        "name": "name"
      },
      "contragent": {
        "ref": "5876419795ed3c0c59b14601",
        "populate": "",
        "type": "referer",
        "name": "contragent"
      },
      "user_id": {
        "required": true,
        "type": "string",
        "name": "user_id"
      },
      "phone": {
        "type": "string",
        "name": "phone"
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "required": true,
        "populate": {
          "filter": "",
          "select": []
        },
        "type": "referer",
        "name": "status"
      },
      "street": {
        "type": "string",
        "name": "street"
      },
      "building": {
        "type": "string",
        "name": "building"
      },
      "subcontragent": {
        "required": true,
        "ref": "59b24e0dbc280b12d32b98c7",
        "populate": false,
        "type": "referer",
        "name": "subcontragent"
      }
    },
    "adapter": "MongoDB",
    "indexes": ""
  },
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "58c10bd8e42c18189482ffc8"
  },
  "name": "reset_password_tokens",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "password": {
        "type": "string",
        "name": "password"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "58cba0b1877a69030be5bdec"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\nСкрипт для проверки кода верификации\n@param username - логин пользователя\n@param code - код из смс\n@return OK\n*/\nlet mobileUserRole = \"58b40f669154c320f9831bfa\";\nif (!data.username) throw new Error(400, 'Username is empty');\nif (!data.code) throw new Error(400, 'Code field is empty');\nlet verificationCodesTable = yield Table.fetch('verification_codes', req.application.id);\nlet verificationCode = yield verificationCodesTable.find({username: data.username, code: data.code}).catch(e =\u003e (console.error(e), { data: null }));\nif (!verificationCode.data) throw new Error(404, 'Code not found');\nreturn done({data: 'OK'});\n"
  },
  "name": "check_code",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "58b6a6ad91a2f13f65144aa1"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\nФункция восстановления пароля мобильного пользователя\n1---\n@param username - логин пользователя\n2---\n@param username - логин пользователя\n@param code - код верификации\n@param newPassword - новый пароль\n*/\n\nlet mobileUserRole = \"58b40f669154c320f9831bfa\";\nif (!data.username) throw new Error(400, 'Username is empty');\nlet userSys = yield User.find({username: data.username, role: mobileUserRole, type: 'oauth'}, {}, req.application.id);\nif (!userSys) throw new Error(404, 'User not found');\n\nif (data.username \u0026\u0026 !data.code) {\n  let code = Math.round(Math.random() * (9999 - 1298) + 1298);\n  let verificationCodesTable = yield Table.fetch('verification_codes', req.application.id);\n  let verificationCode = yield verificationCodesTable.find({username: userSys.username}).catch(e =\u003e (console.error(e), { data: null }));\n  if (!verificationCode.data) {\n    verificationCode = yield verificationCodesTable.create({username: userSys.username, code: code});\n  } else {\n    verificationCode = yield verificationCode.data.update({code: code});\n  }\n\n    let notify = yield Service.fetch('notify', req.application.id);\n    notify.data = {to:[{number: userSys.username}], code: code };\n    let res = yield notify.request('sms_reset_psw', req);\n\n  return done({data: 'SMS has been send!'});\n}\n\n\nif (data.username \u0026\u0026 data.code \u0026\u0026 data.newPassword) {\n  let verificationCodesTable = yield Table.fetch('verification_codes', req.application.id);\n  let verificationCode = yield verificationCodesTable.find({username: userSys.username, code: data.code}).catch(e =\u003e (console.error(e), { data: null }));\n  if (!verificationCode.data) throw new Error(404, 'Code not found');\n  yield verificationCodesTable.remove({id: verificationCode.data.id});\n  userSys.password = data.newPassword;\n  yield userSys.save();\n  return done({data: 'OK'});\n}\nreturn new Error(400, 'Bad request');\n"
  },
  "name": "reset_password",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "590c7c159c0e8a5acb6e4724"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\nСкрипт для логаута.\nПараметров нет.\n*/\n\nvar options = {\n oauth: {\n accessTokenLifetime: 60 * 60 * 24,\n refreshTokenLifetime: 60 * 60 * 24 * 7\n }\n};\n\nlet access_token = req.oauth.bearerToken.accessToken;\nreq.body = access_token;\n\nlet logout = yield Auth.logout.oauth(req, options).catch(err =\u003e null);\nlet data = yield deletePushTokenScript.run();\n\ndone({data: 'OK'});\n"
  },
  "name": "logout_mobile",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5926e534293de763a62e9b68"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "try {\n    let table = yield Table.fetch('certificates', req.application.id);\n    let certificate = yield table.findAll({id: data.certificate_id});\n\n    if (!certificate.data.length) { return done(certificate); }\n  \n  \u0009certificate.data[0].server_time = Date.now();\n  \n    let userIds = certificate.data[0].user_id;\n    console.log('User Ids:', userIds);\n\n    if (!userIds.length) { return done(certificate); }\n    table = yield Table.fetch('contragents', req.application.id);\n    let contragents = yield table.findAll({user_id: {$in: userIds}});\n    console.log('Contragents:', contragents.data);\n  \n  \u0009// Определяем телефон доставки и имя контрагента и на основе количества заполняем метаданные сертификата\n    if (!contragents.data.length) { return done(certificate); }\n\n   /* if (contragents.data.length == 1) {\n\u0009  \u0009console.log('!');\n\u0009    let contragentPhone = contragents.data[0].phone;\n\u0009    certificate.data[0].contragent_phone = contragentPhone;\n\u0009    let contragentName = contragents.data[0].name;\n\u0009    certificate.data[0].contragent_name = contragentName;\n    }*/\n    let ca = contragents.data.map(contragent =\u003e {\n        return {id: contragent.id, name: contragent.name, phone: contragent.phone, user_id: contragent.user_id};\n    }); \n    Object.assign(certificate.data[0], {contragents: ca}); \n    done(certificate);\n} catch(err) {\n    done('\\\"\\\"');\n}"
  },
  "name": "certificate_generator",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e75bed505b9850a6759a8c"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/*\n\u0009Скрипт который будет валидировать имена у сущностей Товары, Категории, Контрагенты, Торговые точки. \n\u0009@param - productName\n\u0009@param - categoryName\n\u0009@param - contragentName\n\u0009@param - storeName\n\n\u0009закрыт для внешнего использования\n*/\n\n\nif (data.productName || data.categoryName || data.contragentName || data.storeName) {\n\u0009const activeStatus = '598d9bac47217f28ba69e0f5';\n\u0009const productsTable = yield Table.fetch('products', req.application.id);\n\u0009const categoryTable = yield Table.fetch('product_categories', req.application.id);\n\u0009const contragentsTable = yield Table.fetch('contragents', req.application.id);\n\u0009const storesTable = yield Table.fetch('stores', req.application.id);\n\u0009let isUnique = false;\n\n\u0009if (data.productName) {\n\u0009\u0009let product = yield productsTable.find({name: { $regex: `^${data.productName}$`, $options: 'i'}, status: activeStatus}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009\u0009if (!product.data) isUnique = true;\n\u0009}\n\n\u0009if (data.categoryName) {\n\u0009\u0009let category = yield categoryTable.find({name: { $regex: `^${data.categoryName}$`, $options: 'i'}, status: activeStatus}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009\u0009if (!category.data) isUnique = true;\n\u0009}\n\n\u0009if (data.contragentName) {\n\u0009\u0009let contragent = yield contragentsTable.find({name: { $regex: `^${data.contragentName}$`, $options: 'i'}, status: activeStatus}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009\u0009if (!contragent.data) isUnique = true;\n\u0009}\n\n\u0009if (data.storeName) {\n\u0009\u0009let store = yield storesTable.find({name: { $regex: `^${data.storeName}$`, $options: 'i'}, status: activeStatus}).catch(e =\u003e (console.log(e), {data: null}));\n\u0009\u0009if (!store.data) isUnique = true;\n\u0009}\n\u0009return done(isUnique);\n} throw new Error(400, 'No name param');\n"
  },
  "name": "entity_validator",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e85c8b505b9850a6759d55"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Редактирование категории\n\u0009@param - {\n\u0009\u0009id - обязательно\n\u0009}\n*/\n\nif (!data.id) throw new Error(400, 'Bad request!');\n\nif (data.name) {\n\u0009const validator = yield Script.fetch('entity_validator', req.application.id);\n\u0009validator.req = req;\n\u0009validator.data = {categoryName: data.name};\n\u0009let validation = yield validator.run();\n\u0009if (!validation) throw new Error(400, 'Name is not unique!');\n}\n\nlet categoryTable = yield Table.fetch('product_categories', req.application.id);\nlet category = yield categoryTable.find({id: data.id}).catch(e =\u003e {throw new Error(404, 'Category not found!');});\n\nif (data.is_adult == true) {\n\u0009const productTable = yield Table.fetch('products', req.application.id);\n\u0009let products = yield productTable.findAll({categories: data.id});\n\u0009yield products.data.map(function*(product) {\n\u0009\u0009yield product.update({is_adult: true});\n\u0009});\n}\n\nif(data.is_adult == false) {\n\u0009const productTable = yield Table.fetch('products', req.application.id);\n\u0009let products = yield productTable.findAll({categories: data.id});\n\u0009yield products.data.map(function*(product) {\n\u0009\u0009yield product.update({is_adult: false});\n\u0009});\n\n}\n\nlet result = yield category.data.update(data);\nif (!result) throw new Error(400, 'Cant edit category!');\nreturn done(result);\n\n"
  },
  "name": "edit_category",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e87fe7505b9850a6759e20"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Создать товар\n\u0009@param - столбцы таблицы\n\u0009@param couponsGuid - guid купонов\n\u0009@param limit - число купонов\n\u0009@param duration - время действия купонов\n*/\n\nconst categoryTopId = '58e5f191d351f81cc3fa6a0a';\nconst adminRole = '58808abccf1f550f22a8c02a';\n\nif(!data.user_id || data.user_id.length == 0) throw new Error(400, 'Cant create product without contragent!');\n\n\nif (~data.categories.indexOf(categoryTopId) \u0026\u0026 req.user.role.id != adminRole) throw new Error(400, 'Only admins can set products in top category!');\n\nif (~data.categories.indexOf(categoryTopId)) {\n\u0009const checkScript = yield Script.fetch('check_category_top', req.application.id);\n\u0009checkScript.req = req;\n\u0009checkScript.data = {};\n\u0009let res = yield checkScript.run();\n\u0009if (res instanceof Error) throw new Error(400, 'Top category product limit exceeded!');\n}\n\nconst validator = yield Script.fetch('entity_validator', req.application.id);\nvalidator.req = req;\nvalidator.data = {productName: data.name};\nlet validation = yield validator.run();\n\nif (!validation) throw new Error(400, 'Name is not unique!');\n\nObject.assign(data, { is_coupon_limited: !!data.couponsGuid});\nconst productTable = yield Table.fetch('products', req.application.id);\nlet result = yield productTable.create(data);\nif (!result) throw new Error(400, 'Cant create product!');\n\nif (data.couponsGuid) {\n\u0009const confirmCoupons = yield Script.fetch('confirm_coupons', req.application.id);\n\u0009confirmCoupons.req = req;\n\u0009confirmCoupons.data = {\n\u0009\u0009guid: data.couponsGuid,\n\u0009\u0009product_id: result.id\n\u0009};\u0009\n\u0009yield confirmCoupons.run();\n}\nconst limitsTable = yield Table.fetch('limits', req.application.id);\nconst limitsResult = yield limitsTable.create({\n\u0009product_id: result.id,\n\u0009user_id: req.user.id,\n\u0009limit: data.limit,\n\u0009duration: data.duration\n});\n\nreturn done(result);\n"
  },
  "name": "create_product",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e87ff5505b9850a6759e22"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n Редактирование товара\n @param - id - id товара для редактирования\n @param couponsGuid - guid купонов\n @param limit - число купонов\n @param duration - время действия купонов\n */\n// если есть топ и топом остается проверки не нужны\n// если не админ то only admin...\n// лимит и проверка\nif (!data.id) throw new Error(400, 'Bad request!');\n\n// если продукт с купонами уже, либо с лимитами, то сменить это уже нельзя\nif (data.is_coupon_limited === false || data.is_coupon_limited === true) throw new Error(400, 'Cant change product type');\n\nconst categoryTopId = '58e5f191d351f81cc3fa6a0a';\nconst adminRole = '58808abccf1f550f22a8c02a';\n\nif(!data.user_id || data.user_id.length == 0) throw new Error(400, 'Cant create product without contragent!');\n\nlet productTable = yield Table.fetch('products', req.application.id);\nlet product = yield productTable.find({id: data.id}).catch(e =\u003e {throw new Error(404, 'Product not found!');});\n\n\nlet catIds = product.data.categories.map(category =\u003e {\n    return category.id.toString();\n});\n\nif (!(~data.categories.indexOf(categoryTopId) \u0026\u0026 ~catIds.indexOf(categoryTopId))) {\n    if (~data.categories.indexOf(categoryTopId) \u0026\u0026 req.user.role.id != adminRole) throw new Error(400, 'Only admins can set products in top category!');\n\n    if (~data.categories.indexOf(categoryTopId)) {\n        const checkScript = yield Script.fetch('check_category_top', req.application.id);\n        checkScript.req = req;\n        checkScript.data = {};\n        let res = yield checkScript.run();\n        if (res instanceof Error) throw new Error(400, 'Top category product limit exceeded!');\n    }\n}\n\n\n\n\nif (data.name) {\n    const validator = yield Script.fetch('entity_validator', req.application.id);\n    validator.req = req;\n    validator.data = {productName: data.name};\n    let validation = yield validator.run();\n    if (!validation) throw new Error(400, 'Name is not unique!');\n}\n\n\n\nlet result = yield product.data.update(data);\nif (!result) throw new Error(400, 'Cant edit product!');\n\nif (data.couponsGuid) {\n    const confirmCoupons = yield Script.fetch('confirm_coupons', req.application.id);\n    confirmCoupons.req = req;\n    confirmCoupons.data = {\n        guid: data.couponsGuid,\n        product_id: data.id\n    };\n    yield confirmCoupons.run();\n}\n\nif(data.limit || data.duration) {\n    let params = {};\n\n    if (data.limit) params.limit = data.limit;\n    if (data.duration) params.duration = data.duration;\n\n    const limitsTable = yield Table.fetch('limits', req.application.id);\n    const limit = yield limitsTable.find({product_id: data.id}).catch(e =\u003e (console.log(e), {data: null}));\n    const limitsResult = yield limit.data.update(params);\n}\n\n\nreturn done(result);\n"
  },
  "name": "edit_product",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e88002505b9850a6759e24"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Создать магазин\n\u0009@param - {\n\u0009\u0009столбцы таблицы\n\u0009}\n*/\n\nconst storesTable = yield Table.fetch('stores', req.application.id);\nlet result = yield storesTable.create(data);\nif (!result) throw new Error(400, 'Cant create store!');\n\nreturn done(result);\n\n"
  },
  "name": "create_store",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59e8800e505b9850a6759e26"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Редактирование магазина\n\u0009@param - {\n\u0009\u0009id - обязательно\n\u0009}\n*/\n\n\nif (!data.id) throw new Error(400, 'Bad request!');\n\nlet storeTable = yield Table.fetch('stores', req.application.id);\nlet store = yield storeTable.find({id: data.id}).catch(e =\u003e {throw new Error(404, 'Store not found!');});\nlet result = yield store.data.update(data);\nif (!result) throw new Error(400, 'Cant edit store!');\nreturn done(result);"
  },
  "name": "edit_store",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59f9b0b8c180901b8cd04f0b"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": [
          "run"
        ]
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\n  кейс заказ звонка\n  @param contragent_id - id контрагента\n  @param product_id - id продукта\n  @param message - сообщение от пользователя\n  @param user_phone - телефон пользователя пользователя\n  @param certificate_id - id джипона - если его нет то @param certificate_code - code джипона\n                         @param product_name - имя продукта\n                        \n                        \n  Если вызов происходит с web-сертификата то \n  @param - user_name - Имя человека делающего заказ\n  @param - user_phone - телефон человека делающего заказ\n\n*/\n\nif (!data.contragent_id || !data.product_id) throw new Error(400, 'Bad request');\nconst mobileRole = '58b40f669154c320f9831bfa';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nconst contragentTable = yield Table.fetch('contragents', req.application.id);\n\nconst productsTable = yield Table.fetch('products', req.application.id);\nlet product = yield productsTable.find({id: data.product_id}).catch(e =\u003e (console.error(e), {data: null}));\nif (!product.data) throw new Error(404, 'Product not found!');\n\n\n// call мобилка сама достанет телефон из джипона\n/*if (product.data.is_delivery \u0026\u0026 product.data.delivery_type === true) {\n  let contragent = yield contragentTable.find({user_id: data.contragent_id}).catch(e =\u003e done(e));\n  return done(product.data.delivery_phone || contragent.data.phone);\n}*/\n\n// call_back\nif (product.data.is_delivery \u0026\u0026 product.data.delivery_type === false) {\n  let userSys;\n  let sendData = {}; // обьект будет содержать все данные которые нужно будет по почте отправить\n  if (data.message) Object.assign(sendData, {message: data.message});\n\n\n  let contragent = yield contragentTable.find({user_id: data.contragent_id}).catch(e =\u003e done(e));\n     if (!contragent.data.delivery_email) {\n      userSys = yield User.find({id: contragent.data.user_id}, {}, req.application.id);\n     } \n\n\n     if (data.certificate_id) {\n      const certificatesTable = yield Table.fetch('certificates', req.application.id);\n      let gpon = yield certificatesTable.find({id: data.certificate_id, status: activeStatus}).catch(e =\u003e done(e));\n\n      Object.assign(sendData, {gponCode: gpon.data.code, productName: gpon.data.product.name});\n     } else if(data.certificate_code \u0026\u0026 data.product_name) {\n      Object.assign(sendData, {gponCode: data.certificate_code, productName: data.product_name});\n     } else {\n      throw new Error(400, 'Bad request!');\n     }  \n\n\n     if (req.user \u0026\u0026 req.user.id \u0026\u0026 req.user.role.id == mobileRole) {\n      const usersTable = yield Table.fetch('users', req.application.id);\n      let user = yield usersTable.find({user_id: req.user.id}).catch(e =\u003e done(e));\n      Object.assign(sendData, {userName: user.data.name, userPhone: data.user_phone || user.data.phone});\n     } else if (data.user_name \u0026\u0026 data.user_phone) {\n\n      Object.assign(sendData, {userName: data.user_name, userPhone: data.user_phone});\n     } else {\n      throw new Error(400, 'Bad request!');\n     }\n\nlet sendEmail = contragent.data.delivery_email || userSys.username;\nconst notify = yield Service.fetch('notify', req.application.id);\nnotify.data = Object.assign(sendData, {to:[{email: sendEmail}]});\nyield notify.request('call_back', req);\n\nreturn done('OK!');\n\n}\n\nthrow new Error(400, 'Bad request!');\n\n"
  },
  "name": "delivery_service",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59fc0a20c180901b8cd05ab0"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009mobile \u0026\u0026 desktop\n\u0009подгрузить все категории и количество товаров в каждой из них\n*/ \n// категорию топ брать с другого места\n// params поиск по имени\n\nconst adminRole = '58808abccf1f550f22a8c02a';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\nconst mobileRole = '58b40f669154c320f9831bfa';\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst categoryTopId = '58e5f191d351f81cc3fa6a0a';\n\nlet params = {\n\u0009//product: data.product_id,\n\u0009status: activeStatus,\n};\n\nif (req.user.role.id == mobileRole) {\n\u0009const checkAdultScript = yield Script.fetch('check_is_adult', req.application.id);\n\u0009checkAdultScript.req = req;\n\u0009checkAdultScript.data = {};\n\u0009let check_adult = yield checkAdultScript.run();\n\u0009if (!check_adult) {\n      \u0009Object.assign(params, {is_adult: false});\n    }\n}\n\nif (data.name) params.name =  { $regex: data.name, $options: 'i' };\n\nlet options = {};\nif (data.limit) options.limit = data.limit;\nif (data.page) options.skip = data.page * data.limit || 0;\nif (data.sort) options.sort = data.sort;\n\nconst categoriesTable = yield Table.fetch('product_categories', req.application.id);\nconst productsTable = yield Table.fetch('products', req.application.id);\nlet categories = yield categoriesTable.findAll(params, options);\n\nyield categories.data.map(function* (category) {\n\n\n\u0009if (req.user.role.id == adminRole) {\n\u0009\u0009let products = yield productsTable.findAll({categories: category.id, status: activeStatus});\n\u0009\u0009Object.assign(category, {count: products.count});\n\u0009}\n\n\u0009if (req.user.role.id == contragentRole) {\n\u0009\u0009let products = yield productsTable.findAll({categories: category.id, status: activeStatus, user_id: req.user.id});\n\u0009\u0009Object.assign(category, {count: products.count});\n\u0009}\n\n});\n\nreturn done(categories.data);\n"
  },
  "name": "get_categories",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "59fc4bf0c180901b8cd05e77"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "const activeStatus = '598d9bac47217f28ba69e0f5';\nlet params = {\n\u0009status: activeStatus,\n};\n\nif (data.name) params.name =  { $regex: data.name, $options: 'i' };\n\nlet options = {};\nif (data.limit) options.limit = data.limit;\nif (data.page) options.skip = data.page * data.limit || 0;\nif (data.sort) options.sort = data.sort;\n\nconst contragentsTable = yield Table.fetch('contragents', req.application.id);\nconst storesTable = yield Table.fetch('stores', req.application.id);\nconst productsTable = yield Table.fetch('products', req.application.id);\n\nlet contragents = yield contragentsTable.findAll(params, options);\n\nyield contragents.data.map(function* (contragent) {\n\u0009let stores = yield storesTable.findAll({user_id: contragent.user_id, status: activeStatus});\n\u0009let products = yield productsTable.findAll({user_id: contragent.user_id, status: activeStatus});\n\u0009Object.assign(contragent, {stores_count: stores.count, products_count: products.count});\n});\n\n\nreturn done(contragents.data);\n"
  },
  "name": "get_contragents",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a02acc9c180901b8cd06624"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Скрипт для админа и контрагента\n\u0009@param - contragent_id - id системного пользователя контрагента\n*/\n\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\nconst overdueStatus = '598d9bba47217f28ba69e0fd';\nconst cashStatus = '598d9bb147217f28ba69e0fc';\n\nconst params = {};\n\nif (data.end_sale_date) params.end_sale_date = { $gt: data.end_sale_date};\n\nif (req.user.role.id == contragentRole) {\n\u0009data.contragent_id = req.user.id;\n\u0009params.user_id = data.contragent_id;\n\u0009params.$or = [{ status: cashStatus }, { status: overdueStatus }]\n} else {\n\u0009params.user_id = data.contragent_id;\n}\n\nif (!data.contragent_id) throw new Error(400, 'Bad request!');\n\n\nconst contragentsTable = yield Table.fetch('contragents', req.application.id);\nlet contragent = yield contragentsTable.find({user_id: data.contragent_id}).catch(e =\u003e (console.error(e), {data: null}));\nif (!contragent.data) throw new Error(404, 'Contragent not found!');\n\nlet userSys = yield User.find({id: data.contragent_id}, {}, req.application.id);\nif (!userSys) throw new Error(404, 'User not found!');\n\nObject.assign(contragent.data, {email: userSys.username});\n\nconst storesTable = yield Table.fetch('stores', req.application.id);\nlet stores = yield storesTable.findAll({user_id: data.contragent_id, status: activeStatus});\n\nconst productsTable = yield Table.fetch('products', req.application.id);\nlet products = yield productsTable.findAll({user_id: data.contragent_id, status: activeStatus});\n\nconst certificateTable = yield Table.fetch('certificates', req.application.id);\nlet certificates = yield certificateTable.findAll(params);\n\nreturn done({data: {contragent: contragent.data, stores_count: stores.count, products_count: products.count, certificates_count: certificates.count}});\n\n\n\n"
  },
  "name": "get_contragent",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a045ac1ba295309c4031f09"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009Скрипт для подгрузки данных о контрагенте и его представителе\n    @param - user_id - системный id контрагента\n*/\n\nconst contragentRole = '58860d1bc6887053b5978bb3';\n\nif (req.user.role.id == contragentRole) data.user_id = req.user.id;\n\nif (!data.user_id) throw new Error(400, 'Bad request!');\nlet result = {data: {}};\nconst contragentsTable = yield Table.fetch('contragents', req.application.id);\nlet contragent = yield contragentsTable.find({user_id: data.user_id}).catch(e =\u003e (console.error(e), {data: null}));\n\nlet caUserSys = yield User.find({id: data.user_id}, {}, req.application.id);\n\nif (!contragent.data || !caUserSys) throw new Error(404, 'Contragent not found!');\nObject.assign(contragent.data, {email: caUserSys.username});\nObject.assign(result.data, {contragent: contragent.data});\n\nconst subcontragentsTable = yield Table.fetch('subcontragents', req.application.id);\nlet subcontragent = yield subcontragentsTable.find({contragent_id: data.user_id}).catch(e =\u003e (console.error(e), {data: null}));\nif (subcontragent.data) {\n  let subCaUserSys = yield User.find({id: subcontragent.data.user_id}, {}, req.application.id);\n    Object.assign(result.data, {subcontragent: {username: subCaUserSys.username}});\n}\n\nreturn done(result);\n\n\n"
  },
  "name": "get_contragent_info",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a16fcc6b6b7e15bf964fd11"
  },
  "type": "Script",
  "options": {
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "run"
        ]
      }
    },
    "editorOptions": {
      "mode": "javascript",
      "autoRefresh": true,
      "autoCloseBrackets": true,
      "matchBrackets": true,
      "lineWrapping": true,
      "lineNumbers": true
    },
    "code": "/**\n\u0009@param end_sale_date - показать джипоны дата окончания продажи которых больше этой\n\u0009@param limit\n\u0009@param page\n\u0009@param sort\n\n*/\nconst adminRole = '58808abccf1f550f22a8c02a';\nconst contragentRole = '58860d1bc6887053b5978bb3';\nconst activeStatus = '598d9bac47217f28ba69e0f5';\n\nconst overdueStatus = '598d9bba47217f28ba69e0fd';\nconst cashStatus = '598d9bb147217f28ba69e0fc';\n\nconst params = {};\n\nif (data.end_sale_date) params.end_sale_date = { $gt: data.end_sale_date};\n\nconst options = {\n\u0009select: [\"buy_date\", \"buyer_id\", \"code\", \"end_sale_date\", \"expiration_days\", \"order_id\", \"product\", \"status\", \"status_updated_at\", \"user_id\"]\n};\n\nif (req.user.role.id == adminRole) options.select.push(\"pin\");\nif (req.user.role.id == contragentRole) {\n\u0009params.user_id = req.user.id;\n\u0009params.$or =  [ { status: cashStatus }, { status: overdueStatus }];\n} \n\nif (data.limit) options.limit = data.limit;\nif (data.page) options.skip = data.page * data.limit || 0;\nif (data.sort) options.sort = data.sort;\nif (data.contragent_id) params.user_id = data.contragent_id;\n\nconst certificatesTable = yield Table.fetch('certificates', req.application.id);\nlet certificates = yield certificatesTable.findAll(params, options);\n\nreturn done({data: certificates.data, count: certificates.count});\n"
  },
  "name": "get_gpons_list",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  }
}
{
  "_id": {
    "$oid": "5a8acc1b265be1072082751f"
  },
  "name": "product_contragent_cards",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": [
          "create",
          "list",
          "view",
          "update",
          "delete"
        ]
      }
    },
    "fields": {
      "product_id": {
        "required": true,
        "ref": "58973d924802c138d75d91e6",
        "populate": false,
        "type": "referer",
        "name": "product_id"
      },
      "commission_individual": {
        "type": "number",
        "name": "commission_individual"
      },
      "stores": {
        "ref": "5876420595ed3c0c59b14606",
        "populate": false,
        "required": true,
        "array": true,
        "type": "referer",
        "name": "stores"
      },
      "product_name_aliase": {
        "type": "string",
        "name": "product_name_aliase"
      },
      "contragent_id": {
        "required": true,
        "type": "string",
        "name": "contragent_id"
      },
      "status": {
        "ref": "598d9a4747217f28ba69e0f3",
        "populate": false,
        "required": true,
        "type": "referer",
        "name": "status"
      }
    },
    "adapter": "MongoDB"
  }
}
{
  "_id": {
    "$oid": "5aaa8438265be10720827c88"
  },
  "name": "cloud_user_cards",
  "type": "Table",
  "application": {
    "$oid": "587640c995ed3c0c59b14600"
  },
  "options": {
    "triggers": "",
    "params": {
      "timestamps": true
    },
    "rules": {
      "public": {
        "access": []
      },
      "all": {
        "access": []
      }
    },
    "fields": {
      "first_four": {
        "type": "string",
        "name": "first_four"
      },
      "last_four": {
        "type": "string",
        "name": "last_four"
      },
      "type": {
        "type": "string",
        "name": "type"
      },
      "token": {
        "type": "string",
        "name": "token"
      },
      "user_id": {
        "type": "string",
        "name": "user_id"
      },
      "is_default": {
        "type": "boolean",
        "name": "is_default"
      },
      "name": {
        "type": "string",
        "name": "name"
      }
    },
    "adapter": "MongoDB"
  }
}
